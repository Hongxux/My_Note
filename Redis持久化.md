持久化的基础
- AOF
- RDB
- [[混合持久化]]
---

持久化设置：
- 用来做缓存的Redis实例尽量不要开启持久化功能
	- 对于分布式锁和库存这类对安全性要求高的开启持久化
- RDB和AOF的选择：
	- 关闭RDB持久功能，使用AOF持久化
		- 数据丢失风险小，数据安全性好
	- 利用脚本在slave节点，实现定期数据备份
		- RDB文件小，适合做备份
- AOF使用设置：
	- 设置合理的rewrite阈值，避免频繁的bgrewrite
		- AOF频繁的写内存和刷盘对cpu和IO性能要求高
	- 配置no-appendfsync-on-rewrite=yes，
		- 含义：禁止在rewrite期间做aof
		- no-appendfsync-on-rewrite=yes的好处：增加可用性![[Pasted image 20251126132535.png]]
			- 如果aof的fsync时间过长，主线程认为出问题的，于是进行主线程阻塞
			- 而做RDB全量同步和rewrite会占用大量IO资源，会导致fsync时长增加
			- 因此为了避免主线程阻塞，要禁止在rewrite期间做aof，避免fsync时间增加
			- 在禁止aof的期间可能导致数据丢失，所以这是性能和数据安全性的权衡
- Redis部署建议：
	- ① Redis实例的物理机要预留足够内存，应对fork和rewrite
	- ②单机多实例部署，单个Redis实例内存上限不要太大，例如4G或8G。
		- 可以加快fork的速度、减少主从同步、数据迁移压力
	- ③ 不要与CPU密集型应用部署在一起
		- 对fork和rewrite的时候对cpu消耗高
	- ④不要与高硬盘负载应用一起部署。例如:数据库、消息队列
		- rewrite和aof都要高磁盘读写
