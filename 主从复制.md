## 概述

主从复制是 MySQL 提供的高可用性、高性能和数据备份的基础技术。它解决了数据库的单点故障和性能瓶颈问题。
**生产环境注意事项**​：

- ​**异步复制**​：默认情况下，MySQL 复制是**异步**的，这意味着主从数据存在毫秒级的延迟。对数据强一致性要求极高的场景（如金融交易）需特别注意。
    
- ​**监控延迟**​：需要监控从库的复制延迟（Seconds_Behind_Master），确保其在可接受范围内。
    
- ​**半同步复制**​：对于要求更高的场景，可以使用**半同步复制**，确保至少一个从库收到日志后，主库的事务才算提交成功，增强数据可靠性。
#### 一、 主从复制是什么？


- ​**核心定义**​：主从复制是指**将主数据库的 DDL（数据定义语言，如建表）和 DML（数据操纵语言，如增删改）操作通过二进制日志传到从库服务器中，然后在从库上对这些日志重新执行（也叫重做），从而使得从库和主库的数据保持同步。​**​
    ![[Pasted image 20251104095017.png]]
- ​**工作流程详解（对应流程图）​**​：
    
    1. ​**主库记录日志**​：主库（Master）在执行事务提交前，会将数据变更事件**顺序写入**本机的二进制日志文件中。
        
    2. ​**从库拉取日志**​：从库（Slave）的 ​**I/O 线程**​ 会与主库建立一个连接，并请求主库推送自指定位置后的二进制日志内容。
        
    3. ​**从库缓存日志**​：从库的 I/O 线程接收到日志后，将其写入本地的**中继日志**文件中。
        
    4. ​**从库重放日志**​：从库的 ​**SQL 线程**​ 会读取中继日志中的内容，并重放其中记录的 SQL 事件，从而保持与主库的数据一致性。
        
    
- ​**高级特性**​：
    
    - ​**一主多从**​：一台主库可以同时向多台从库进行复制。
        
    - ​**链式复制**​：从库（A）可以作为其他从库（B）的主库，实现级联复制，减轻主库的压力。
        
    

#### 二、 为什么要使用主从复制？

图2清晰地列出了主从复制的三大核心优点，这正是其在生产环境中被广泛采用的原因。

##### 1. ​**高可用性与故障恢复**​
    
- ​**场景**​：当主库因为硬件故障、宕机或维护需要停机时，可以**快速地将应用切换到从库**上继续提供服务。
	
- ​**价值**​：大大缩短了系统的不可用时间，实现了服务的高可用性。
        
    
##### 2. ​**读写分离与负载均衡**​

- ​**场景**​：在大多数应用中，读操作（SELECT）远多于写操作（INSERT/UPDATE/DELETE）。可以配置应用程序，将**写请求**全部发送到**主库**，将**读请求**分发到一个或多个**从库**。
	
- ​**价值**​：
	
	- ​**降低主库压力**​：主库可以专注于处理写操作，提升系统整体吞吐量。
		
	- ​**提升读性能**​：通过增加从库，可以线性地扩展系统的读能力。
            
        
    
##### 3. ​**数据备份与数据分析**​
    
- ​**安全备份**​：可以在从库上执行耗时的备份操作（如 `mysqldump`），而**完全不影响主库**的线上服务。（因为要使用全局锁）
	
- ​**离线分析**​：可以在从库上运行复杂的统计查询或数据挖掘任务，这些重量级操作不会对线上业务产生性能干扰。
        
    
​


## 搭建


![[Pasted image 20251104095546.png]]

### 主库配置

#### 第一步：准备工作

1. ​**准备两台服务器**​：
    
    - ​**主库 (Master)​**: 192.168.200.200
        
    - ​**从库 (Slave)​**: 192.168.200.201
        
    
2. ​**基础环境**​：
    
    - 在两台服务器上**安装MySQL**并完成初始化。
        
    - ​**开放3306端口**​ 或 ​**关闭防火墙**，确保主从服务器之间网络互通。
        
    - ​**命令示例**​：
        
        ```
        # 开放3306端口
        firewall-cmd --zone=public --add-port=3306/tcp --permanent
        firewall-cmd --reload
        # 或关闭防火墙（生产环境不推荐）
        systemctl stop firewalld
        ```
        
    

#### 第二步：配置主库 (Master) 参数

​**配置文件**​：`/etc/my.cnf`

​**需要修改或增加的配置**​：

```
[mysqld]
# 1. 设置Server ID（核心参数）
server-id = 1

# 2. 启用二进制日志（核心参数）
log-bin = mysql-bin

# 3. 设置主库为可读写（默认值，可省略 0是读写 1是只读）
read-only = 0

# 4. 【可选】指定要同步的数据库（如不配置，默认同步所有库）
# binlog-do-db = db1

# 5. 【可选】指定忽略同步的数据库（如不配置，默认同步所有库）
# binlog-ignore-db = mysql
```

​**关键参数解读**​：

- ​**`server-id`**​：​**必须唯一**。在整个主从复制集群中，每个节点的ID都不能重复。
    
- ​**`log-bin`**​：开启二进制日志功能。这是主从复制的**基石**，主库的所有数据变更都记录在这里。
    
- ​**`read-only=0`**​：确保主库是可读可写的。
    

#### 第三步：重启服务并创建复制账号

1. ​**重启MySQL使配置生效**​：
    
    ```
    systemctl restart mysqld
    ```
    
2. ​**登录MySQL，创建用于从库复制的账号**​：
    
    ```
    -- 1. 创建用户（'itcast'是用户名，'%'表示允许任意主机连接，'Root@123456'是密码）
    CREATE USER 'itcast'@'%' IDENTIFIED BY 'Root@123456';
    
    -- 2. 授予主从复制权限
    GRANT REPLICATION SLAVE ON *.* TO 'itcast'@'%';
    
    -- 3. 刷新权限
    FLUSH PRIVILEGES;
    ```
    
    - ​**目的**​：从库使用这个账号和密码来连接主库，并拉取二进制日志。
        
    

#### 第四步：查看主库状态，记录关键坐标

执行以下命令，并**记录结果**，在配置从库时会用到：

```
SHOW MASTER STATUS;
```

​**输出示例及解读**​：

```
+------------------+----------+--------------+------------------+-------------------+
| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |
+------------------+----------+--------------+------------------+-------------------+
| mysql-bin.000003 |      663 |              |                  |                   |
+------------------+----------+--------------+------------------+-------------------+
```

- ​**File (`mysql-bin.000003`)​**​：主库当前正在使用的二进制日志文件名。
    
- ​**Position (`663`)​**​：当前二进制日志文件的位置点。
    
- ​**重要性**​：​**从库将从File和Position指定的这个“坐标”开始，进行数据同步。​**​
    

### 总结与下一步

至此，主库的配置已经全部完成。您已经得到了两个关键信息：

1. 用于复制的账号：`itcast`/ `Root@123456`
    
2. 主库的二进制日志坐标：`File`(mysql-bin.000003) 和 `Position`(663)
    



### 从库配置



#### 第一步：配置从库参数并重启

​**操作：​**​ 修改从库的 MySQL 配置文件 `/etc/my.cnf`。

​**配置内容：​**​

```
# mysql服务ID，保证整个集群环境中唯一，取值范围：1 - 2^32-1，和主库不一样即可
server-id=2

# 是否只读，1代表只读，0代表读写
read-only=1
```

​**关键解读：​**​

- ​**`server-id=2`**​：这是**必须参数**。在整个主从复制集群中，每个节点的 `server-id`必须是**唯一**的，不能与主库（通常为1）或其他从库重复。这是从库被识别的唯一标识。
    
- ​**`read-only=1`**​：这是**推荐参数**。将从库设置为只读模式，可以防止应用意外地在从库上进行数据写入，导致主从数据不一致。这符合从库主要承担读流量的角色。
    

​**生效操作：​**​

```
systemctl restart mysqld
```

修改配置后，必须重启MySQL服务才能使新配置生效。

#### 第二步：设置主库连接信息（核心步骤）

此步骤用于告知从库如何连接到主库。​**MySQL 8.0.23**​ 是一个重要的版本分水岭，引入了新的、更中立的语法。

​**1. MySQL 8.0.23 及之后版本（推荐新语法）​**​

```
CHANGE REPLICATION SOURCE TO
SOURCE_HOST='192.168.200.200', -- 主库的IP地址
SOURCE_USER='itcast',           -- 在主库上创建的复制账号
SOURCE_PASSWORD='Root@123456', -- 复制账号的密码
SOURCE_LOG_FILE='mysql-bin.000001', -- 主库的Binlog文件名（来自SHOW MASTER STATUS）
SOURCE_LOG_POS=441;            -- 主库的Binlog位置点（来自SHOW MASTER STATUS）
```

​**2. MySQL 8.0.23 之前版本（旧语法）​**​

```
CHANGE MASTER TO
MASTER_HOST='192.168.200.200',
MASTER_USER='itcast',
MASTER_PASSWORD='Root@123456',
MASTER_LOG_FILE='mysql-bin.000001',
MASTER_LOG_POS=441;
```

​**参数对照表（图2内容精华）：​**​

|新语法参数 (>=8.0.23)|旧语法参数 (<8.0.23)|含义|
|---|---|---|
|`SOURCE_HOST`|`MASTER_HOST`|主库IP地址|
|`SOURCE_USER`|`MASTER_USER`|连接主库的用户名|
|`SOURCE_PASSWORD`|`MASTER_PASSWORD`|连接主库的密码|
|`SOURCE_LOG_FILE`|`MASTER_LOG_FILE`|主库的binlog日志文件名|
|`SOURCE_LOG_POS`|`MASTER_LOG_POS`|主库的binlog日志文件位置|

#### 第三步：启动复制并检查状态

​**1. 启动复制线程**​

- ​**MySQL 8.0.22 及之后版本：​**​
    
    ```
    START REPLICA;
    ```
    
- ​**MySQL 8.0.22 之前版本：​**​
    
    ```
    START SLAVE;
    ```
    
    这条命令会启动从库上的两个核心线程：​**I/O 线程**​（负责从主库拉取日志）和 ​**SQL 线程**​（负责重放日志）。
    

​**2. 检查复制状态（最关键的一步）​**​

- ​**MySQL 8.0.22 及之后版本：​**​
    
    ```
    SHOW REPLICA STATUS\G
    ```
    
- ​**MySQL 8.0.22 之前版本：​**​
    
    ```
    SHOW SLAVE STATUS\G
    ```
    
    使用 `\G`是为了使输出格式更易读。
    

​**状态解读（成功的关键指标）：​**​

执行上述命令后，在返回的结果中，你必须关注以下两个**最关键**的字段：

- ​**`Replica_IO_Running`(或 `Slave_IO_Running`)​**: 值必须为 `Yes`。这表示 I/O 线程工作正常，能成功连接到主库并获取二进制日志。
    
- ​**`Replica_SQL_Running`(或 `Slave_SQL_Running`)​**: 值必须为 `Yes`。这表示 SQL 线程工作正常，能成功重放中继日志中的事件。
    

​**只有当这两个字段的值都为 `Yes`时，才表示主从复制链路建立成功，数据正在正常同步。​**​

### 总结

这三张图为您提供了配置MySQL从库的完整、标准的操作流程：

1. ​**基础配置**​：设置唯一 `server-id`和 `read-only`模式。
    
2. ​**核心链接**​：使用 `CHANGE ... TO`命令，根据MySQL版本选择正确语法，准确填写主库信息。
    
3. ​**启动与验证**​：使用 `START ...`命令启动复制，并使用 `SHOW ... STATUS`命令验证，确保两个 `Running`状态均为 `Yes`。
    

​**注意**​：在整个配置过程中，​**MySQL大版本的差异是首要考虑的因素**，使用错误的语法会导致命令执行失败。遵循这个流程，您就能成功地搭建起MySQL主从复制环境。