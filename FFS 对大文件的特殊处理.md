
### ​**FFS 对大文件的特殊处理：平衡局部性与空间利用率**​

FFS的通用策略是将相关数据聚集在同一柱面组内。然而，对于大文件，严格遵循此策略会产生严重问题，因此FFS引入了一个重要的例外规则。

#### ​**一、 问题：大文件与空间局部性的矛盾**​

- ​**冲突点**​： 如果一个非常大的文件的所有数据块都被集中放置在一个柱面组内，会完全**占满该组的空闲空间**。
    
- ​**负面后果**​： 这将阻止后续与该文件“相关”的其他文件（例如，同一目录下的其他文件）被放置在该组中，从而**破坏了FFS努力维持的目录内局部性**。
    

#### ​**二、 解决方案：将大文件分块散布**​

为了解决上述矛盾，FFS对大文件采用了一种折衷策略：

- ​**核心思想**​： 将一个大文件分割成多个**连续的块**，并将这些大块**分散存储到不同的柱面组**中。
    
- ​**具体实现（基于inode结构）​**​：
    
    1. 文件开头的部分（例如，对应inode中**12个直接指针**所指向的块，即前48KB左右）仍然与文件inode存放在**同一个组**中，以保证小文件或文件开头的高效访问。
        
    2. 此后，文件后续的每个**大块**​（例如，由**每个间接指针块**所管理的数据块，约4MB）被放置到一个**新的、空间利用率较低的柱面组**中。
        
    
- ​**效果图示**​：
    
    - ​**无大文件例外**​： `[文件块0-9]`全部集中在组G0。
        
    - ​**有大文件例外**​： `[块0-1]`在G0，`[块2-3]`在G1，`[块4-5]`在G2，... 文件块被分散到多个组。
        
    

#### ​**三、 性能权衡与摊销技术**​

分散存储显然会损害大文件的**顺序读取性能**，因为读取过程中需要额外的**寻道**操作。FFS通过精心选择**块的大小**来**摊销**寻道开销。

- ​**摊销原理**​： 通过让每次寻道后传输足够大量的数据，使**数据传输时间**远大于**寻道时间**，从而将寻道开销平摊，使整体性能接近磁盘的顺序传输带宽。
    
- ​**计算示例**​：
    
    - 假设磁盘平均寻道时间为10ms，传输速率为40 MB/s。
        
    - 为了达到峰值带宽的50%（即寻道时间=传输时间），需要每次传输约 ​**409.6 KB**​ 的数据块。
        
    - 为了达到峰值带宽的90%，则需要每次传输约 ​**3.69 MB**​ 的数据块。
        
    
- ​**FFS的实际选择**​： FFS并未直接进行上述计算，而是基于其inode结构（直接块、间接块）自然地实现了分块。使用4KB块大小和32位地址时，每个间接块管理4MB数据，这恰好是一个合理的块大小。
    

#### ​**四、 技术发展趋势的启示**​

- ​**背景**​： 磁盘的**传输速率**提升较快，而**机械寻道速度**提升缓慢。
    
- ​**启示**​： 随着时间的推移，寻道的相对成本越来越高。为了有效摊销这笔固定的机械开销，​**每次寻道后需要传输的数据量（即块大小）也必须相应增加**，这一趋势影响着现代文件系统的设计。
    

---

​**核心结论**​：

FFS对大文件的处理体现了其设计的实用性。它通过在**局部性**和**空间利用率**之间进行明智的权衡，并运用**摊销**技术来最小化性能损失，确保了系统在绝大多数场景下都能获得良好的整体性能。这再次彰显了其“磁盘感知”的设计哲学。