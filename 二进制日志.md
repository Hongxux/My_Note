---
aliases:
  - binlog
---
- 需求背景：
	- 主从复制的需求：实现读写分离，高可用
	- 数据崩溃恢复的需求：作为增量备份
	- 操作历史回溯的需求
- 日志记录内容：![[Pasted image 20251128143439.png]]
	- 元数据：事件头
		- timestamp：事件发生的时间点
		- type_code：事件的类型编码
			- `FORMAT_DESCRIPTION_EVENT`(0x0F)
			- `QUERY_EVENT`(0x02)
		- server_id：产生此事件的数据库服务器的唯一ID
			- 用于主从复制中，避免循环复制和标识来源。
		- event_length：整个事件的总长度，包括事件头和事件体。
		- next_position：下一个事件在binlog文件中的起始位置
			- 用于将事件串联起来
		- flags：描述事件特定属性的标志位
			- 如是否启用临时表特殊处理等
	- 内容：事件体，因事件类型（type_code）的不同而有巨大差异
		- `FORMAT_DESCRIPTION_EVENT`：binlog 文件的第一个事件
			- 包含了诸如 binlog 格式版本号、MySQL 服务器版本号、事件头长度以及所有类型事件的"事件体"头部长度等信息
				- 后续事件的解析都依赖于此事件提供的信息
		- `QUERY_EVENT`：执行的 SQL 语句
			 - DML语句：记录所有数据修改操作，包括：
			    - INSERT：插入新数据
			    - UPDATE：更新现有数据
			    - DELETE：删除数据
			- DDL语句：记录数据库结构变更，包括：
			    - CREATE：创建表、索引等
			    - ALTER：修改表结构
			    - DROP：删除表或索引
		- `ROTATE_EVENT`：指示下一个要使用的 binlog 文件的文件名
			- 位置：文件尾
			- 时机：
				- binlog 文件大小达到上限
				- 执行 `FLUSH LOGS`命令
		- `XID_EVENT`：
			- 时机：在事务提交时写入
			- 内容：主要包含一个 `xid`​ 字段，即事务的唯一标识符
				- 用于标识一个已提交的事务
	- TCL语句：记录事务控制操作，如COMMIT、ROLLBACK
- 日志记录的格式：使用 `SHOW VARIABLES LIKE 'binlog_format';`查看当前格式。
	- STATEMENT：记录原始的SQL语句（已逐渐被淘汰）![[Pasted image 20251104091804.png]]
		- 好处：
			- 日志文件小，节省空间
			- 记录执行上下文信息：时间戳、客户端等等
		- 问题：可能导致主从不一致
			- 使用了某些函数（如`NOW()`、`RAND()`、`UUID()`）
	- ROW：记录​修改前、修改后的值（默认格式）![[Pasted image 20251104091201.png]]
		- 好处：​数据安全可靠，主从一致性高
		- 坏处：
			- 日志文件大
				- 批量操作时会产生大量日志（如更新100万行会产生100万条记录）
				- 而STATEMENT只产生一条数据
	
	- MIXED：多数情况用 STATEMENT，在不安全的场景下（如使用不确定函数）自动切换为 ROW（通用场景）
	
- 日志记录的查看方式：二进制日志是二进制格式，无法直接阅读，需使用官方工具 `mysqlbinlog`。
	- **基本命令**​：`mysqlbinlog [options] logfilename`
	- **常用参数**​：
		- 指定数据库：`-d database_name`
		- 忽略看的条目数：`-o n`忽略日志中的前 n 个条目。
		- 重构ROW格式的数据为SQL：`-v`
			- `-vv`：在 `-v`基础上，增加更详细的注释信息。
		- 指定时间范围：`--start-datetime=/--stop-datetime`
		- 指定日志为支点：`--start-position=/--stop-position`

	- **示例**​：`mysqlbinlog -v -d mydb binlog.000001`会以可读形式显示 `mydb`数据库在 `binlog.000001`文件中记录的所有变更。
- 日志清理方式：

二进制日志会不断增长，占用大量磁盘空间，必须定期清理。

|命令|作用|风险|
|---|---|---|
|`RESET MASTER;`|​**删除所有**二进制日志文件，并**重置索引**，从 `binlog.000001`重新开始。|​**极其危险**​！仅在从库不需要、且无备份恢复需求的测试环境使用。|
|`PURGE MASTER LOGS TO 'binlog.000010';`|删除指定编号**之前**的所有日志（即删除 `binlog.000001`到 `binlog.000009`）。|相对安全，确保要删除的日志已经不再需要。|
|`PURGE MASTER LOGS BEFORE '2023-10-01 12:00:00';`|删除指定时间点**之前**生成的所有日志。|相对安全，需确认时间点。|

​**生产环境建议**​：设置参数 `expire_logs_days`，让 MySQL 自动清理过期的日志文件，这是最安全稳妥的方式。
