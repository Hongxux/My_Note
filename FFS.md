---
aliases:
  - 快速文件系统
---
### FFS的核心机制和核心政策
#### 一、核心机制：[[FFS的柱面组结构]]
#### 二、核心政策：
- 一般规则：[[FFS的数据分配策略]]
- 除外：[[FFS 对大文件的特殊处理]]


### ​**FFS 的其他关键创新与改进**​

除了核心的“磁盘感知”布局策略外，FFS还引入了多项重要创新，这些改进涵盖了**空间效率**、**低级性能优化**和**系统可用性**等多个维度。

#### ​**一、 提升空间效率：子块设计**​

FFS针对小文件存储造成的空间浪费问题，提出了巧妙的解决方案。

- ​**问题背景**​：
    
    - 为提升传输效率，FFS采用较大的块大小（如4KB）。
        
    - 但当时存在大量小文件（约2KB），若直接使用4KB块存储，会导致近**50%的磁盘空间被浪费（内部碎片）​**。
        
    
- ​**解决方案：引入子块**​
    
    - ​**机制**​： FFS引入了更小的分配单元——**子块**​（通常为512字节）。
        
    - ​**工作流程**​：
        
        1. 小文件首先由若干个连续的**子块**​ 存储。
            
        2. 当文件增长到足以填满一个完整的4KB块时，FFS会执行**提升**操作：找到一个空闲的4KB块，将子块中的数据复制进去，然后释放原先占用的子块。
            
        
    - ​**利弊权衡**​：
        
        - ​**优点**​： 极大提升了小文件存储的**空间效率**。
            
        - ​**缺点**​： ​**提升**操作会导致额外的I/O开销，​**性能低下**。
            
        
    - ​**优化措施**​： 为避免这种性能损耗，FFS修改了C库，令其在用户空间将写入**缓冲**至4KB后再一次性提交给文件系统，从而在大多数情况下避免了使用子块。
        
    

#### ​**二、 优化顺序读写：参数化布局**​

FFS还针对当时磁盘的机械特性，进行了极致的低级性能优化。

- ​**问题：旋转延迟**​
    
    - 在顺序读取连续存储的文件时，由于磁盘旋转速度很快，当系统读完块`N`并处理完中断再去请求块`N+1`时，块`N+1`的起始位置可能已经转过了磁头，导致需要**等待整整一圈旋转**才能读取。
        
    
- ​**解决方案：交错布局**​
    
    - ​**机制**​： FFS不将文件块连续放置，而是采用**跳跃式**的布局（例如，在物理位置上将连续的逻辑块号分别放置在磁盘的1, 3, 5, 7...扇区）。
        
    - ​**参数化**​： FFS能够**自动检测**特定磁盘的机械性能（旋转速度、处理延迟），计算出最优的跳跃间隔，以实现最高效的连续读取。这个过程称为**参数化**。
        ![[Pasted image 20251012152140.png]]
    
- ​**现代演进**​： 此优化主要适用于由主机CPU精细控制磁盘操作的时代。现代磁盘内置大容量**磁道缓冲区**，可一次性读取整个磁道并缓存，后续请求可直接从缓存提供，因此文件系统不再需要处理如此低级的布局细节。
    

#### ​**三、 增强系统可用性**​

FFS深刻认识到，一个成功的系统不仅需要技术卓越，更需要**用户友好**。它引入了一系列提升可用性的重要特性：

1. ​**支持长文件名**​： 突破了早期文件系统对文件名的长度限制（如8个字符），允许使用更具描述性的文件名。
    
2. ​**引入符号链接**​： 克服了**硬链接**的两大局限（不能链接目录、不能跨卷），提供了更灵活的文件别名功能。
    
3. ​**原子性重命名操作**​： 引入了原子性的 `rename()`系统调用，确保了文件重命名操作的可靠性，避免了中间状态可能引发的问题。
    

---

​**核心启示**​：

FFS的成功不仅源于其革命性的“磁盘感知”数据布局思想，同样得益于其在**空间效率**、**低级性能优化**上展现的智慧，以及最为关键的——对**系统可用性**的高度重视。这些看似“微小”的改进，如长文件名和符号链接，极大地提升了用户体验，共同构成了FFS的持久影响力。这告诉我们，让一个系统变得**好用**，与其深层的技术创新同等重要。