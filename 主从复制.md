---
aliases:
  - MySQL主从
  - 读写分离
---
- 需求背景：
	1. **负载分摊**：在“读多写少”的应用中，大部分压力来自查询。通过将读请求引导到多个从库，极大地减轻了主库的压力，提升了系统的整体查询吞吐量
    2. **缓解锁竞争**：写操作通常涉及行锁或表锁，会影响并发性。将读、写操作在物理上分离到不同数据库实例，**有效避免了读写操作间对锁的竞争**，使得读和写都能更高效地进行
    3. **资源优化**：可以为从库配置不同的存储引擎（如MyISAM，适用于读多的场景）或优化参数，进一步提升查询性能
- 解决措施：主从复制  
- MySQL 主从复制的三种模式

|模式|工作原理|优点|缺点|适用场景|
|---|---|---|---|---|
|**异步复制**​|主库提交事务后，立即返回客户端成功，**不等待**从库接收确认。|**性能最好**，延迟最低。|**数据一致性最弱**，若主库崩溃，已提交但未同步的数据可能丢失。|对性能要求高、允许少量数据丢失的读密集型业务。|
|**半同步复制**​|主库提交事务前，**至少需要等待一个从库**接收并确认日志。|**平衡性能与一致性**，有效防止单点故障后数据丢失。|**性能有损耗**，增加响应延迟；若从库无响应会降级为异步。|对数据一致性有较高要求的核心业务，如金融交易。|
|**全同步复制**​|主库提交事务前，**需要等待所有从库**都完成事务提交。|**数据一致性最强**，保证主从数据完全同步。|**性能影响最大**，延迟高，可用性受影响。|极少使用，多见于特殊集群方案如 MySQL Group Replication。|
- 问题：**主从延迟**：
	- 延迟监控：通过 `SHOW SLAVE STATUS` 中的 `Seconds_Behind_Master` 字段监控。
	- 造成延迟的根本原因：主从同步通常是异步进行的，这意味着从库的数据会比主库有微小的延迟
	- 增加延迟的原因：
		- **硬件**: 从库配置远低于主库。
		- **读压力**: 大量复杂的读查询消耗了从库的CPU和I/O资源，影响SQL thread的执行。
		- **大事务**: 主库一个大事务（如批量更新几百万行）在从库重放时也会耗时很久，阻塞后续所有操作。
		- **单线程瓶颈**: 在MySQL 5.6之前，SQL thread是单线程的。如果主库是高并发写入，从库的单线程回放能力会成为瓶颈。
    - 解决措施：
	    - 使用多线程复制。
		    -  `DATABASE`粒度: 基于库的并行，如果所有修改都集中在一个库，则无效。
		     - `LOGICAL_CLOCK`粒度 (MySQL 5.7+): 只要事务之间没有数据依赖（如同时修改同一行），就可以并行回放。这是目前最有效的并行复制策略。
		- 避免大事务，将大操作拆分为小批次。
		- 确保从库硬件配置与主库相匹配，或使用更强的硬件作为从库。
	    - 对于写操作后需要立即读取最新数据的场景（如用户下单后马上查看订单），需要特殊处理，比如将这类读请求仍发送到主库
---

- 工作模式：
	- 核心组件
		- **Binary Log (二进制日志)**：
			- 职责：复制的源头。
			- 实现方式：顺序记录主库上所有数据变更
		- **Relay Log (中继日志)**：
			- 职责：复制过程的中转和缓冲
			- 实现方式：从库的I/O线程从主库拉取Binary Log后，会先将其写入本地的Relay Log。
		- **三个核心线程**：
		    - **Binlog Dump Thread**：主库上的线程，负责读取Binary Log并**发送**给从库的I/O线程。
		    - **I/O Thread**：从库上的线程，负责连接主库，请求和接收Binary Log的更新，并**写入Relay Log**。
		    - **SQL Thread**：从库上的线程，负责读取Relay Log中的事件，解析并**执行**其中的SQL语句，最终使从库数据与主库保持一致。
	- 流程：![[Pasted image 20251104095017.png]]
	   1.  **Master**: 事务提交，将数据变更写入 **Binlog**。
	   2.  **Master**: 创建一个 **dump thread**，等待从库的连接请求。
	   3.  **Slave**: **I/O thread** 连接到Master的dump thread，请求指定位置之后的Binlog。
	   4.  **Master**: dump thread收到请求后，将Binlog推送给Slave的I/O thread。
	   5.  **Slave**: I/O thread接收到Binlog内容，写入本地的 **Relay Log (中继日志)**。
	   6.  **Slave**: **SQL thread** 读取Relay Log，重放其中
- 特性：
    - ​**一主多从**​：一台主库可以同时向多台从库进行复制。
    - ​**链式复制**​：从库（A）可以作为其他从库（B）的主库，实现级联复制，减轻主库的压力。
---

## 搭建


![[Pasted image 20251104095546.png]]

### 主库配置

#### 第一步：准备工作
1. ​**准备两台服务器**​：
    - ​**主库 (Master)​**: 192.168.200.200
    - ​**从库 (Slave)​**: 192.168.200.201
2. ​**基础环境**​：
    - 在两台服务器上**安装MySQL**并完成初始化。
    - ​**开放3306端口**​ 或 ​**关闭防火墙**，确保主从服务器之间网络互通。
    - ​**命令示例**​：
        ```
        # 开放3306端口
        firewall-cmd --zone=public --add-port=3306/tcp --permanent
        firewall-cmd --reload
        # 或关闭防火墙（生产环境不推荐）
        systemctl stop firewalld
        ```
#### 第二步：配置主库 (Master) 参数
​**配置文件**​：`/etc/my.cnf`
​**需要修改或增加的配置**​：
```
[mysqld]
# 1. 设置Server ID（核心参数）在整个主从复制集群中，每个节点的ID都不能重复。
server-id = 1
# 2. 启用二进制日志（核心参数）
log-bin = mysql-bin
# 3. 设置主库为可读写（默认值，可省略 0是读写 1是只读）
read-only = 0
# 4. 【可选】指定要同步的数据库（如不配置，默认同步所有库）
# binlog-do-db = db1
# 5. 【可选】指定忽略同步的数据库（如不配置，默认同步所有库）
# binlog-ignore-db = mysql
```
#### 第三步：重启服务并创建复制账号
1. ​**重启MySQL使配置生效**​：
    ```
    systemctl restart mysqld
    ```
2. ​**登录MySQL，创建用于从库复制的账号**​：从库使用这个账号和密码来连接主库，并拉取二进制日志。
    ```
    -- 1. 创建用户（'itcast'是用户名，'%'表示允许任意主机连接，'Root@123456'是密码）
    CREATE USER 'itcast'@'%' IDENTIFIED BY 'Root@123456';
    -- 2. 授予主从复制权限
    GRANT REPLICATION SLAVE ON *.* TO 'itcast'@'%';
    -- 3. 刷新权限
    FLUSH PRIVILEGES;
    ```
#### 第四步：查看主库状态，记录关键坐标
执行以下命令，并**记录结果**，在配置从库时会用到：
```
SHOW MASTER STATUS;
```
​**输出示例及解读**​：
```
+------------------+----------+--------------+------------------+-------------------+
| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |
+------------------+----------+--------------+------------------+-------------------+
| mysql-bin.000003 |      663 |              |                  |                   |
+------------------+----------+--------------+------------------+-------------------+
```
- ​**File (`mysql-bin.000003`)​**​：主库当前正在使用的二进制日志文件名。
- ​**Position (`663`)​**​：当前二进制日志文件的位置点。
- ​**重要性**​：​**从库将从File和Position指定的这个“坐标”开始，进行数据同步。​**​
### 总结与下一步
至此，主库的配置已经全部完成。您已经得到了两个关键信息：
1. 用于复制的账号：`itcast`/ `Root@123456`
2. 主库的二进制日志坐标：`File`(mysql-bin.000003) 和 `Position`(663)
### 从库配置
#### 第一步：配置从库参数并重启
​**操作：​**​ 修改从库的 MySQL 配置文件 `/etc/my.cnf`。
​**配置内容：​**​
```
# mysql服务ID，保证整个集群环境中唯一，取值范围：1 - 2^32-1，和主库不一样即可
server-id=2

# 是否只读，1代表只读，0代表读写
read-only=1
```

​**生效操作：​**​
```
systemctl restart mysqld
```

修改配置后，必须重启MySQL服务才能使新配置生效。
#### 第二步：设置主库连接信息（核心步骤）
此步骤用于告知从库如何连接到主库。​**MySQL 8.0.23**​ 是一个重要的版本分水岭，引入了新的、更中立的语法。
​**1. MySQL 8.0.23 及之后版本（推荐新语法）​**​
```
CHANGE REPLICATION SOURCE TO
SOURCE_HOST='192.168.200.200', -- 主库的IP地址
SOURCE_USER='itcast',           -- 在主库上创建的复制账号
SOURCE_PASSWORD='Root@123456', -- 复制账号的密码
SOURCE_LOG_FILE='mysql-bin.000001', -- 主库的Binlog文件名（来自SHOW MASTER STATUS）
SOURCE_LOG_POS=441;            -- 主库的Binlog位置点（来自SHOW MASTER STATUS）
```
​**2. MySQL 8.0.23 之前版本（旧语法）​**​
```
CHANGE MASTER TO
MASTER_HOST='192.168.200.200',
MASTER_USER='itcast',
MASTER_PASSWORD='Root@123456',
MASTER_LOG_FILE='mysql-bin.000001',
MASTER_LOG_POS=441;
```
​**参数对照表（图2内容精华）：​**​

|新语法参数 (>=8.0.23)|旧语法参数 (<8.0.23)|含义|
|---|---|---|
|`SOURCE_HOST`|`MASTER_HOST`|主库IP地址|
|`SOURCE_USER`|`MASTER_USER`|连接主库的用户名|
|`SOURCE_PASSWORD`|`MASTER_PASSWORD`|连接主库的密码|
|`SOURCE_LOG_FILE`|`MASTER_LOG_FILE`|主库的binlog日志文件名|
|`SOURCE_LOG_POS`|`MASTER_LOG_POS`|主库的binlog日志文件位置|
#### 第三步：启动复制并检查状态
​**1. 启动复制线程**​
- ​**MySQL 8.0.22 及之后版本：​**​
    ```
    START REPLICA;
    ```
- ​**MySQL 8.0.22 之前版本：​**​
    ```
    START SLAVE;
    ```
    这条命令会启动从库上的两个核心线程：​**I/O 线程**​（负责从主库拉取日志）和 ​**SQL 线程**​（负责重放日志）。
​**2. 检查复制状态（最关键的一步）​**​
- ​**MySQL 8.0.22 及之后版本：​**​
    ```
    SHOW REPLICA STATUS\G
    ```
- ​**MySQL 8.0.22 之前版本：​**​
    ```
    SHOW SLAVE STATUS\G
    ```
    使用 `\G`是为了使输出格式更易读。
​**状态解读（成功的关键指标）：​**​
执行上述命令后，在返回的结果中，你必须关注以下两个**最关键**的字段：

- ​**`Replica_IO_Running`(或 `Slave_IO_Running`)​**: 值必须为 `Yes`。这表示 I/O 线程工作正常，能成功连接到主库并获取二进制日志。
- ​**`Replica_SQL_Running`(或 `Slave_SQL_Running`)​**: 值必须为 `Yes`。这表示 SQL 线程工作正常，能成功重放中继日志中的事件。
    
​**只有当这两个字段的值都为 `Yes`时，才表示主从复制链路建立成功，数据正在正常同步。​**​
