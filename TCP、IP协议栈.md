一句话理解TCP/IP协议：**在不保证交付**（丢包：由于路由拥塞、TTL到期、校验失败等）、**不保证按序到达**（失序：由于选择不同路径），**不保证不损坏**（尤其因为无线网络中的信号干扰）**的不可靠网络环境**（IP层“尽最大努力交付”的服务模型）**中，通过序列号、校验和、确认与超时与重传、连接管理、流量控制、拥塞控制等机制，实现可靠的**（弥补了底层网络的不可靠性，确保数据正确、按序、不重复地送达）、**面向连接的**（通信前需先建立连接，通信结束后释放连接）、**端到端**（这是在两个通信进程之间实现的，网络中的路由器不参与TCP的可靠性逻辑）**的字节流**（TCP不感知应用层消息边界，它只把应用数据看作一连串无结构的字节流）**传输服务**。

---

## 面临的问题与解决方案：

### 一、 基础可靠性问题：在不可靠的IP网络上构建可靠连接

这是TCP最核心的使命。

| 问题             | 描述                        | 解决方案                                                                                                                                                                           |
| -------------- | ------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| ​**1. 数据损坏**​  | 比特错误，如电磁干扰导致0变1。          | ​ **[[校验和]]**  ​：TCP头部包含校验和字段。接收方计算校验和不匹配则**静默丢弃**该报文段，发送方因收不到ACK而**触发重传** 。                                                                                                   |
| ​**2. 数据包丢失**​ | 路由器拥塞、链路故障等导致数据包在传输过程中消失。 | ​**确认与超时重传**​：  <br>• ​**正向确认**​：接收方收到数据后回复ACK。  <br>• ​**[[超时重传\|超时计时器]]​**：发送方发送数据后启动计时器，超时未收到ACK则重传。  <br>• **​[[TCP快速重传和快速恢复的协作]]**​：收到3个重复ACK即认为数据包丢失，立即重传而不必等待超时，大幅提升效率。 |
| ​**3. 数据包乱序**​ | 网络多路径等原因导致后发数据包先到。        | ​**[[数据序列号（Sequence Number）]]**：每个字节都有唯一序列号。接收方根据序列号**重新排序**，将有序数据交付给应用层。                                                                                                      |
| ​**4. 数据包重复**​ | 超时重传可能导致接收方收到两个完全相同的数据包。  | ​**序列号**​：接收方通过序列号识别出重复的数据包并将其**丢弃**。                                                                                                                                          |
**[[区分失序，丢失还是重复]]**

---

### 二、 连接管理问题：如何建立和终止逻辑连接

TCP是面向连接的，需要管理连接的生命周期。

| 问题                | 描述                              | 解决方案                                                       |
| ----------------- | ------------------------------- | ---------------------------------------------------------- |
| ​**1. 重复的旧连接请求**​ | 网络延迟导致一个连接的旧SYN包在新连接建立后到达，造成混淆。 | ​**[[三次握手机制]]**​<br>​**关键**​：双方交换初始序列号，确保连接是新的，且双方都具有收发能力。 |
| ​**2. 可靠的连接终止**​  | 如何确保双方都有机会发送完所有数据后再安全关闭连接。      | ​**[[四次挥手]]**                                              |

---

### 三、 资源平衡与性能问题：在共享网络中高效、公平地传输

这是TCP最复杂和活跃的领域。

| 问题                | 描述                                                        | 解决方案                                                                                                                                                                                                                                                                           |     |
| ----------------- | --------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | --- |
| ​**1. 接收方处理不过来**​ | 接收方缓冲区有限，发送方发送过快会导致其缓冲区溢出和数据丢失。                           | ​**流量控制**​：  <br>• ​**[[滑动窗口与流量控制机制\|滑动窗口机制]]​**：                                                                                                                                                                                                                              |     |
| ​**2. 网络处理不过来**​  | 发送方发送速率超过网络路径的承载能力，导致路由器缓冲区溢出、全网拥塞崩溃。                     | ​**拥塞控制**​：一套复杂的算法集，​**网络辅助**的速率限制。  <br>• ​**[[慢启动]]​**：连接开始时指数增长，快速探测可用带宽。  <br>• ​**拥塞避免**​：超过阈值后线性增长，谨慎探索。  <br>• ​**拥塞发生时的反应**​：超时则触发怕**[[超时重传]]**；收到3个重复ACK则执行**[[TCP快速重传和快速恢复的协作]]**<br>• ​**算法演进​：Tahoe -> Reno -> NewReno -> ​[[CUBIC]]​**（Linux默认，基于三次函数，更适应高BDP网络）。 |     |
| ​**3. 低带宽利用率**​   | 在高速长距离网络中，传统基于丢包的算法（如CUBIC）因“Bufferbloat”导致高延迟，且无法快速填满管道。 | ​**新型拥塞控制算法**​：  <br>• ​**BBR**​：Google提出，基于模型。主动测量路径的**最小RTT**和**最大带宽**，并主动将速率维持在此操作点，从而实现高吞吐、低延迟。  <br>• ​**[[Vegas算法]]/[[FAST算法]]** ​：基于延迟的算法，在排队延迟增加时就主动降速，避免丢包。                                                                                                           |     |
| ​**4. 队头阻塞**​     | TCP是字节流协议，如果序列号靠前的数据包丢失，即使后续数据包已到达，应用层也无法读取，必须等待重传。       | ​**此问题在TCP层面无法根除**。解决方案是**在应用层采用新协议**​：  <br>• ​**QUIC**​：基于UDP，在用户空间实现了多个独立的流（Stream），一个流的丢包不会阻塞其他流。                                                                                                                                                                          |     |

---

### 四、 网络环境与扩展性问题：适应现代复杂的网络环境

| 问题                 | 描述                                   | 解决方案                                                                                                                     |
| ------------------ | ------------------------------------ | ------------------------------------------------------------------------------------------------------------------------ |
| ​**1. 路径MTU发现**​   | 数据包超过路径上某个链路的MTU会被分片，降低效率。           | ​**[[TCP 的路径最大传输单元发现（Path MTU Discovery, PMTUD）]]**​：发送设置DF（Don‘t Fragment）标志的包，如果收到”需要分片“的ICMP错误，则减小MTU重试，直到找到路径支持的MTU。 |
| ​**2. 长肥管道**​      | 在高带宽延迟积网络中，窗口最大64KB成为瓶颈。             | ​**窗口缩放选项**​：通过TCP选项将窗口大小从16位缩放至30位，支持高达1GB的窗口。                                                                          |
| ​**3. 序列号回绕**​     | 高速网络中，序列号在MSL时间内回绕，造成混淆。             | ​**时间戳选项**​：作为序列号的扩展，用于**保护防止回绕**，同时也能**精确计算RTT**。                                                                       |
| ​**4. NAT与防火墙穿透**​ | 连接穿过NAT/防火墙后可能因长时间空闲而被删除映射表项，导致连接中断。 | ​**[[TCP的保活机制]]**​ ：定期发送空ACK包，维持NAT映射，并检测对端是否存活。                                                                         |

---

### 五、 安全问题

TCP设计之初缺乏安全考虑。

| 问题              | 描述                     | 解决方案                                                                                                                  |
| --------------- | ---------------------- | --------------------------------------------------------------------------------------------------------------------- |
| ​**1. 连接欺骗**​   | 攻击者伪造IP和序列号，劫持或重置合法连接。 | • ​**序列号随机化**​：使攻击者难以猜测初始序列号。[[ISN_C和ISN_S的区别]]  <br>• ​**加密**​：在传输层（**TLS/SSL**）或网络层（**IPsec**）对数据和序列号进行加密，从根本上防止伪造。 |
| ​**2. 拒绝服务攻击**​ | 如SYN洪水攻击，消耗服务器资源。      | ​**[[SYN Cookies]]**​：服务器不立即分配资源，而是通过计算一个Cookie作为初始序列号发给客户端，等客户端回复第三次握手时验证其合法性后再分配资源。                                 |

### 总结

TCP的演进史，就是一部不断解决可靠性、性能、公平性、安全性和扩展性问题的历史。其解决方案体现了几大核心设计思想：

1. ​**端到端原则**​：将复杂逻辑（可靠性、流量控制）放在终端实现，保持网络核心简单。
    
2. ​**基于反馈的控制循环**​：拥塞控制是一个经典的闭环反馈系统。
    
3. ​**保守与兼容**​：任何改进都必须考虑向后兼容性，导致许多解决方案是增量式的。
    

时至今日，TCP的某些根本性问题（如队头阻塞）已难以在其框架内解决，这也催生了像**QUIC**这样的下一代传输协议。
## 特点：
---

### 1. 可靠传输 (Reliable Data Transfer)

这是TCP最核心的目标，确保数据**按序、无差错、不丢失、不重复**地到达接收方。主要通过三种机制实现：

- ​**确认与[[超时与重传|重传 ]](ACK & Retransmission)​**​：接收方收到数据包后，会发送一个确认（ACK）给发送方。发送方为每个发送的包启动一个定时器，如果在规定时间内没有收到对应的ACK，就认为包丢失并重新发送。
    
- ​ **[[数据序列号（Sequence Number）|序列号]](Sequence Number)​**​：每个字节的数据都被赋予一个唯一的序列号。接收方利用序列号来**检测丢失的包**和**重新排序乱序到达的包**，以确保将数据以正确的顺序提交给应用程序。
    
- ​ **[[校验和|校验和]] (Checksum)​**​：每个TCP报文段都包含一个校验和。接收方会计算校验和，如果与报文中的值不匹配，则丢弃该报文段（发送方之后会重传），以此**检测数据在传输过程中是否发生错误**。
    

### 2. 连接管理 (Connection Management)

TCP在传输数据前必须先在两台主机之间建立一条逻辑连接，传输结束后要释放连接。这就是著名的“三次握手”和“四次挥手”。

- **​[[委托协议栈收发消息 从应用层到传输层#^f3fd3e|三次握手 (Three-way Handshake)​]]**：验证通信双方收发能力正常，为后续数据传输提供可靠性保障（同步数据传输的初始序列号）。​

-  **​[[委托协议栈收发消息 从应用层到传输层#^f09cf3|四次挥手 (Four-way Wavehand)​]]**  ：TCP使用四次挥手机制可靠地关闭连接，确保数据的完整传输和资源的优雅释放​。

### 3. 流量控制 (Flow Control)

传统流量控制：[[滑动窗口与流量控制机制|滑动窗口协议 (Sliding Window Protocol)]]​​ 
面对[[交互式通信]]场景：[[Nagle算法与滑动窗口]]
面对高[[带宽延迟积]]网络：[[大容量缓存与自动调优]]
### 4. [[拥塞]]控制 (Congestion Control)

这是TCP另一个极其重要的核心功能，用于解决**网络中间链路负载过重**的问题。

- ​**目的**​：防止发送方过快地向网络注入大量数据，导致网络路由器或链路因过载而出现拥堵甚至崩溃。
    
- ​**原理**​：发送方通过感知网络的拥堵状况（如超时或重复ACK），动态地调整其发送速率。主要算法包括：
    
    - ​**慢启动 (Slow Start)​**​：连接开始时或发现拥堵后，从很小的速率开始，呈指数级增长，快速探测网络可用带宽。
      慢启动的缺陷（在高速TCP中）
        ![[Pasted image 20250923202709.png]]
    - ​**拥塞避免 (Congestion Avoidance)​**​：到达阈值后，转为线性增长，谨慎地探索更多带宽。
        
    - ​**快速重传 (Fast Retransmit)​**​ 和 ​**快速恢复 (Fast Recovery)​**​：通过收到3个重复ACK来快速检测包丢失并触发重传，避免等待超时，提高效率。
- **难点**：
	- 准确地判断何时需要减缓
	
	- 如何减缓TCP传输
	
	- 何时恢复其原有速度
        
    [[基于SACK的拥塞控制]]
	[[二进制增长的拥塞控制（BIC和CUBIC）]]
	[[基于延迟的拥塞控制算法]]
	[[积极队列管理和ECN|作用于路由器的拥塞控制]]

### 5. 面向字节流 (Byte-Oriented Stream) 和面向连接





    

## TCP头部和封装
![[Pasted image 20250920144450.png]]
![[Pasted image 20250920144537.png]]
#### [[TCP选项]]
#### [[重置报文段]]
#### [[紧急机制]]

## [[TCP的保活机制]]