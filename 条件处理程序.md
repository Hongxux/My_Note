

> ​**条件处理程序（Handler）可以用来定义在流程控制结构执行过程中遇到问题时相应的处理步骤。​**​

您可以将其理解为数据库中的 ​**​“异常处理”或“错误捕获”机制**。它允许你预见到可能发生的特定异常情况（如数据找不到、发生警告或其他错误），并定义当这些情况发生时应执行什么操作（是继续执行还是退出），从而避免整个存储过程因未处理的错误而意外终止。

### 语法结构详解

图中的核心语法结构为：

```
DECLARE handler_action HANDLER
    FOR condition_value [, condition_value] ...
    statement ;
```

这个声明包含三个关键部分：

#### 1. 处理程序操作 - `handler_action`

这决定了当指定的条件发生时，​**整个程序流程该如何进行**。

|操作类型|含义|适用场景|
|---|---|---|
|​**`CONTINUE`**​|​**继续执行**​|当发生的错误或情况可以忽略，或者已得到妥善处理，希望程序继续运行下去时使用。|
|​**`EXIT`**​|​**终止执行**​|当发生严重错误，无法继续后续逻辑，需要立即退出当前的 `BEGIN...END`复合语句块时使用。|

#### 2. 触发条件 - `condition_value`

这定义了**何种情况会触发**这个处理程序。

|条件类型|含义|说明与示例|
|---|---|---|
|​**`SQLSTATE sqlstate_value`**​|​**特定的状态码**​|最精确的匹配方式。`sqlstate_value`是一个5字符的字符串代码。例如，`'02000'`通常表示 `NOT FOUND`（游标取不到更多数据）。|
|​**`SQLWARNING`**​|​**所有警告**​|匹配所有以 `'01'`开头的 `SQLSTATE`代码。这是一种快捷方式，用于捕获所有警告类信息。|
|​**`NOT FOUND`**​|​**数据未找到**​|匹配所有以 `'02'`开头的 `SQLSTATE`代码。​**这是最常用的条件之一**，尤其在游标遍历中，用于判断是否已读取完所有数据。|
|​**`SQLEXCEPTION`**​|​**所有错误**​|匹配所有**既不是警告`(01)`也不是NOT FOUND`(02)`**​ 的 `SQLSTATE`代码（即错误码）。用于捕获所有真正的错误。|

#### 3. 执行语句 - `statement`

这是当条件被触发时**要执行的具体操作**。它可以是一条简单的语句（如 `SET`赋值），也可以是用 `BEGIN ... END`包裹的复合语句块。

### 完整工作流程与实战示例

条件处理程序最经典的应用场景就是与**游标**结合，安全地遍历数据。

```
DELIMITER $$
CREATE PROCEDURE SafeProcessUsers()
BEGIN
    -- 1. 声明变量
    DECLARE v_id INT;
    DECLARE v_name VARCHAR(100);
    DECLARE done INT DEFAULT FALSE; -- 用于标记循环结束

    -- 2. 声明游标
    DECLARE user_cursor CURSOR FOR SELECT id, username FROM users;

    -- 3. 【核心】声明条件处理程序
    -- 当游标FETCH不到数据（发生NOT FOUND条件）时，将done标记设为TRUE，并继续执行(CONTINUE)
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;

    -- 4. 打开游标并开始循环
    OPEN user_cursor;

    read_loop: LOOP
        FETCH user_cursor INTO v_id, v_name; -- 获取一行数据

        -- 检查处理程序是否已被触发（即done是否为TRUE）
        IF done THEN
            LEAVE read_loop; -- 如果已触发，说明没有数据了，退出循环
        END IF;

        -- 这里是处理每一行数据的业务逻辑
        -- 例如，插入日志或进行某些计算
        INSERT INTO process_log (user_id, message) VALUES (v_id, CONCAT('Processed: ', v_name));

    END LOOP;

    CLOSE user_cursor; -- 关闭游标
END
$$
DELIMITER ;
```

