---
aliases:
  - Guarded Suspension
---

- 需求背景：一个线程需要等待另一个线程的执行结果
- 含义：如果结果尚未就绪，该线程会主动暂停（阻塞），直到条件满足后被唤醒
- 流程：![[Pasted image 20251201131744.png]]
	- 核心组件：GuardedObject
		- 持有需要传递的结果，
		- 并提供`get()`和`complete()`方法
			- `get()`：用`while`循环判断条件，若结果未就绪，则调用`wait()`释放锁并等待
				- while条件判断避免虚假唤醒
			- `complete()`：设置结果后，调用`notifyAll()`唤醒所有等待的线程
				- notifyAll避免随机唤醒了不能正确处理这个条件/结果的线程
- 拓展一：增加超时机制
```java
public Object get(long timeout){
	synchronized(this){
		//开始时间15:00:00
		long begin =System.currentTimeMillis();
		// 经历的时间
		long passedTime = 0;
		while(response ==null){
			// 这一轮循环应该等待的时间
			long waitTime =timeout -passedTime;
			/!经历的时间超过了最大等待时间时，退出循环
			if(waitTime<=0){
				break;
			}
			try{
				this.wait(waitTime);// 虚假唤解 15:00:01
			}catch(InterruptedExceptione) e.printstackTrace();
			// 求得经历时间
			passedTime=System.currentTimeMillis()begin;//15:00:02 1s
		}
		return response;
	}
}
```
- 拓展二：解耦生产者和消费者
	- [[生产者消费者模式]]
