# ä¸ºä»€ä¹ˆéœ€è¦Redisé›†ç¾¤
[[Redisé›†ç¾¤]]
# æ­å»ºä¸»ä»æ¶æ„
åœ¨å•å° Rocky Linux è™šæ‹Ÿæœºä¸Šæ­å»º Redis ä¸€ä¸»äºŒä»æ¶æ„ï¼Œæ˜¯é€šè¿‡åˆ›å»ºä¸‰ä¸ªåœ¨ä¸åŒç«¯å£ä¸Šè¿è¡Œçš„ Redis å®ä¾‹æ¥å®ç°çš„ã€‚è¿™ç§æ–¹æ³•éå¸¸é€‚åˆå­¦ä¹ å’ŒåŠŸèƒ½æµ‹è¯•ã€‚å…¶æ ¸å¿ƒæ¶æ„å’Œé…ç½®å·®å¼‚å¯ä»¥é€šè¿‡ä¸‹è¡¨å¿«é€ŸæŒæ¡ï¼š

|å®ä¾‹è§’è‰²|è¿è¡Œç«¯å£|æ ¸å¿ƒé…ç½®é¡¹|è¯´æ˜|
|---|---|---|---|
|**ä¸»èŠ‚ç‚¹ (Master)**â€‹|6379|æ— éœ€ç‰¹æ®Šé…ç½®|é»˜è®¤å¤„ç†å†™è¯·æ±‚ï¼Œæ•°æ®å˜æ›´ä¼šè‡ªåŠ¨åŒæ­¥åˆ°ä»èŠ‚ç‚¹|
|**ä»èŠ‚ç‚¹1 (Slave)**â€‹|6380|`replicaof 127.0.0.1 6379`|æŒ‡å®šä¸»èŠ‚ç‚¹åœ°å€å’Œç«¯å£ï¼Œå¤åˆ¶ä¸»èŠ‚ç‚¹æ•°æ®|
|**ä»èŠ‚ç‚¹2 (Slave)**â€‹|6381|`replicaof 127.0.0.1 6379`|åŒä¸Šï¼Œå®ç°ä¸€ä¸ªä¸»èŠ‚ç‚¹å¯¹åº”å¤šä¸ªä»èŠ‚ç‚¹|

### ğŸ”§ è¯¦ç»†é…ç½®æ­¥éª¤

#### 1. å‡†å¤‡é…ç½®æ–‡ä»¶

é¦–å…ˆï¼Œä¸ºæ¯ä¸ªå®ä¾‹åˆ›å»ºç‹¬ç«‹çš„é…ç½®æ–‡ä»¶ã€æ•°æ®ç›®å½•å’Œæ—¥å¿—æ–‡ä»¶ï¼Œè¿™æ˜¯é¿å…å†²çªçš„å…³é”®ã€‚

```
# åˆ›å»ºä¸“ç”¨çš„é…ç½®ã€æ•°æ®å’Œæ—¥å¿—ç›®å½•
sudo mkdir -p /etc/redis /var/lib/redis/{6379,6380,6381} /var/log/redis
```

**é…ç½®ä¸»èŠ‚ç‚¹ (Master - 6379)**

åˆ›å»ºå¹¶ç¼–è¾‘ `/etc/redis/6379.conf`ï¼š

```
port 6379
bind 0.0.0.0  
daemonize yes
pidfile /var/run/redis_6379.pid
logfile /var/log/redis/redis-server-6379.log
dir /var/lib/redis/6379  
dbfilename dump-6379.rdb  
appendonly yes  
appendfilename "appendonly-6379.aof"
# å¯é€‰ï¼šè®¾ç½®å¯†ç ï¼Œä¸»ä»èŠ‚ç‚¹éœ€ä¸€è‡´
# requirepass YourStrongPassword
# masterauth YourStrongPassword
```

_å…³é”®ç‚¹ï¼šä¸»èŠ‚ç‚¹é…ç½®ç›¸å¯¹ç®€å•ï¼Œé‡ç‚¹æ˜¯å®šä¹‰å¥½åŸºç¡€è·¯å¾„å’Œç«¯å£ã€‚_

**é…ç½®ä»èŠ‚ç‚¹ (Slaves - 6380 & 6381)**

åˆ›å»ºå¹¶ç¼–è¾‘ä»èŠ‚ç‚¹é…ç½®æ–‡ä»¶ï¼Œä¾‹å¦‚ `/etc/redis/6380.conf`ã€‚å…¶å†…å®¹ä¸ä¸»èŠ‚ç‚¹å¤§éƒ¨åˆ†ç›¸åŒï¼Œä¸»è¦åŒºåˆ«åœ¨äºç«¯å£å’Œç›¸å…³æ–‡ä»¶è·¯å¾„ï¼Œå¹¶ä¸”å¿…é¡»é€šè¿‡ `replicaof`æŒ‡ä»¤æŒ‡å®šä¸»èŠ‚ç‚¹ ã€‚

```
port 6380
bind 0.0.0.0
daemonize yes
pidfile /var/run/redis_6380.pid
logfile /var/log/redis/redis-server-6380.log
dir /var/lib/redis/6380
dbfilename dump-6380.rdb
appendonly yes
appendfilename "appendonly-6380.aof"
# æ ¸å¿ƒé…ç½®ï¼šæŒ‡å®šä¸»èŠ‚ç‚¹
replicaof 127.0.0.1 6379
# å¦‚æœä¸»èŠ‚ç‚¹è®¾ç½®äº†å¯†ç ï¼Œä»èŠ‚ç‚¹éœ€è¦é…ç½®ä»¥ä¸‹ä¸¤é¡¹
# requirepass YourStrongPassword  # ä»èŠ‚ç‚¹è‡ªèº«å¯†ç ï¼ˆè‹¥éœ€è¦ï¼‰
# masterauth YourStrongPassword   # ä¸»èŠ‚ç‚¹çš„å¯†ç 
```

é…ç½®æ–‡ä»¶ `/etc/redis/6381.conf`å‚ç…§æ­¤æ ¼å¼ï¼Œå°†å…¶ä¸­æ‰€æœ‰ `6380`æ›¿æ¢ä¸º `6381`å³å¯ã€‚

#### 2. å¯åŠ¨Rediså®ä¾‹
**è¦ä»¥rootç”¨æˆ·å¯åŠ¨**
```
su
```
ä½¿ç”¨å„è‡ªçš„é…ç½®æ–‡ä»¶å¯åŠ¨ä¸‰ä¸ªRedisæœåŠ¡ã€‚

```
redis-server /etc/redis/6379.conf
redis-server /etc/redis/6380.conf
redis-server /etc/redis/6381.conf
```

å¯åŠ¨åï¼Œä½¿ç”¨ `ps aux | grep redis-server`å‘½ä»¤æ£€æŸ¥æ˜¯å¦æœ‰ä¸‰ä¸ªè¿›ç¨‹æ­£å¸¸è¿è¡Œã€‚

#### 3. éªŒè¯ä¸»ä»å…³ç³»

è¿™æ˜¯æ£€éªŒé…ç½®æ˜¯å¦æˆåŠŸçš„å…³é”®ä¸€æ­¥ã€‚

**æ£€æŸ¥ä¸»èŠ‚ç‚¹çŠ¶æ€**

è¿æ¥ä¸»èŠ‚ç‚¹ï¼ŒæŸ¥çœ‹å¤åˆ¶ä¿¡æ¯ï¼š

```
redis-cli -p 6379 info replication
```
![[Pasted image 20251123110842.png]]
åœ¨è¾“å‡ºä¿¡æ¯ä¸­ï¼Œæ‚¨åº”è¯¥èƒ½çœ‹åˆ° `role:master`ä»¥åŠ `connected_slaves:2`ï¼Œä¸‹é¢ä¼šåˆ—å‡ºä¸¤ä¸ªä»èŠ‚ç‚¹çš„è¿æ¥ä¿¡æ¯ ã€‚

**æ£€æŸ¥ä»èŠ‚ç‚¹çŠ¶æ€**

åˆ†åˆ«è¿æ¥ä¸¤ä¸ªä»èŠ‚ç‚¹æŸ¥çœ‹çŠ¶æ€ï¼š

```
redis-cli -p 6380 info replication
redis-cli -p 6381 info replication
```
![[Pasted image 20251123110922.png]]
å®ƒä»¬çš„è¾“å‡ºä¸­åº”æ˜¾ç¤º `role:slave`å’Œ `master_link_status:up`ï¼Œè¿™è¡¨æ˜ä¸»ä»åŒæ­¥è¿æ¥æ­£å¸¸ ã€‚

**æ•°æ®åŒæ­¥æµ‹è¯•**

åœ¨ä¸»èŠ‚ç‚¹å†™å…¥ä¸€ä¸ªæ•°æ®ï¼Œç„¶ååœ¨ä»èŠ‚ç‚¹æŸ¥è¯¢ï¼ŒéªŒè¯æ•°æ®æ˜¯å¦åŒæ­¥ã€‚

```
# åœ¨ä¸»èŠ‚ç‚¹å†™å…¥
redis-cli -p 6379 set "mykey" "Hello from Master"

# åœ¨ä»èŠ‚ç‚¹è¯»å– (æ³¨æ„ï¼šä»èŠ‚ç‚¹é»˜è®¤åªè¯»ï¼Œä¸èƒ½æ‰§è¡Œå†™æ“ä½œ)
redis-cli -p 6380 get "mykey"
redis-cli -p 6381 get "mykey"
```
![[Pasted image 20251123110945.png]]



![[Pasted image 20251122202552.png]]
### æ•°æ®åŒæ­¥åŸç†
#### å…¨é‡åŒæ­¥
![[Pasted image 20251122204708.png]]
-  å¦‚ä½•çŸ¥é“æ˜¯ä¸æ˜¯ç¬¬ä¸€æ¬¡åŒæ­¥--ä¸¤ä¸ªé‡è¦çš„æ•°æ®ç»“æ„![[Pasted image 20251122211551.png]]![[Pasted image 20251122212049.png]]
	- slaveè¯·æ±‚æ•°æ®åŒæ­¥çš„æ—¶å€™ï¼Œä¼šå£°æ˜ä½ çš„replication idå’Œoffsetï¼Œå‘Šè¯‰masterä½ çš„æ•°æ®é›†æ¥è‡ªå“ªé‡Œï¼ŒåŒæ­¥äº†å¤šå°‘
		- åªè¦replication idä¸ä¸€æ ·åˆ™è¯´æ˜æ˜¯ç¬¬ä¸€æ¬¡åŒæ­¥![[Pasted image 20251122211912.png]]

#### å¢é‡åŒæ­¥
![[Pasted image 20251123132816.png]]
- å¢é‡åŒæ­¥çš„å¤±è´¥å’Œå¢é‡åŒæ­¥çš„é€€åŒ–ï¼š
![[Pasted image 20251123132757.png]]
- repl_baklogæœ¬è´¨æ˜¯ä¸€ä¸ªç¯å½¢æ•°æ®,æ•°æ®å†™æ»¡äº†ä¼šè¦†ç›–ä¹‹å‰çš„æ•°æ®ï¼Œå¦‚æœæ²¡æœ‰åŠæ—¶åŒæ­¥ï¼Œåˆ™ä¼šå¯¼è‡´å¾…åŒæ­¥æ•°æ®ä¸¢å¤±ï¼Œæ­¤æ—¶åˆ™åªèƒ½é€€åŒ–æˆå…¨é‡åŒæ­¥ç¡®ä¿æ•°æ®ä¸€è‡´æ€§ã€‚
- ![[Pasted image 20251123132922.png]]Slaveå’ŒMasterä¹‹é—´çš„å·®è·ä¸è¦è¶…è¿‡repl_baklogçš„ç¯å½¢æ•°ç»„çš„é•¿åº¦å³å¯
		 
#### åŸºäºåŸç†æé«˜ä¸»ä»åŒæ­¥çš„æ€§èƒ½

1. ä¼˜åŒ–å…¨é‡åŒæ­¥çš„æ€§èƒ½ï¼š
	- æ— ç£ç›˜åŒæ­¥ï¼šä¸å°†æ•°æ®å†™å…¥ç£ç›˜å†ç½‘ç»œä¼ è¾“ç»™ä»èŠ‚ç‚¹ï¼Œè€Œæ˜¯ç›´æ¥ç½‘ç»œä¼ è¾“ç»™ä»èŠ‚ç‚¹
		- é…ç½®æ–¹å¼ï¼šåœ¨masterä¸­é…ç½®repl-diskless-syncyeså¯ç”¨æ— ç£ç›˜å¤åˆ¶ï¼Œé¿å…å…¨é‡åŒæ­¥æ—¶çš„ç£ç›˜IO
		- ä½¿ç”¨åœºæ™¯ï¼šå½“ç½‘ç»œé€Ÿåº¦å¿«çš„æ—¶å€™ä½¿ç”¨
	- Rediså•èŠ‚ç‚¹ä¸Šçš„å†…å­˜å ç”¨ä¸è¦å¤ªå¤§ï¼Œå‡å°‘RDBå¯¼è‡´çš„è¿‡å¤šç£ç›˜IO
 2. å°½é‡é¿å…å¢é‡åŒæ­¥é€€åŒ–æˆå…¨é‡åŒæ­¥:
	 - é€‚å½“æé«˜repl baklogçš„å¤§å°ï¼Œ
	 - å‘ç°slaveå®•æœºæ—¶å°½å¿«å®ç°æ•…éšœæ¢å¤
3. å‡è½»mastearå‹åŠ›:ä½¿ç”¨ä¸»-ä»-ä»çš„é“¾å¼ç»“æ„![[Pasted image 20251123133930.png]]
	- å®ç°æ–¹å¼:åœ¨æŒ‡å®šreplicaofçš„æ—¶å€™é€‰æ‹©ä»èŠ‚ç‚¹è€Œä¸æ˜¯ä¸»èŠ‚ç‚¹
- 