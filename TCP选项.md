### 概述

TCP选项是位于TCP标准头部之后的可选字段，用于在连接建立阶段（三次握手）或数据传输阶段，在通信双方之间传递额外的控制信息和参数。标准TCP头部长度是20字节，通过**数据偏移**字段（4比特）指示整个TCP头部的长度（以4字节为单位）。如果数据偏移值大于5（5 * 4 = 20字节），那么多出来的部分就是TCP选项字段。

---

### TCP选项的结构：TLV格式

TCP选项采用一种非常标准且灵活的编码格式，称为 ​**TLV**​：

- ​**T**​ - ​**Kind**​ (1字节)：​**类型**。标识这是哪种选项。
    
- ​**L**​ - ​**Length**​ (1字节，可选)：​**长度**。指定整个选项的长度（包括Kind和Length字段本身）。并非所有选项都有此字段。
    
- ​**V**​ - ​**Data**​ (可变长度，可选)：​**值**。该选项所携带的具体数据。
    

这种结构使得解析器可以轻松地跳过它不认识的选项类型（通过Length字段），实现了极好的可扩展性。

---

### 常见且重要的TCP选项详解

以下是RFC标准中定义的一些最关键和最常用的TCP选项：

#### 1. 选项列表

|Kind (值)|选项名称|Length|功能描述|出现阶段|
|---|---|---|---|---|
|0|​**End of Option List**​|1|选项列表结束标志。|握手/数据|
|1|​**No-Operation (NOP)​**​|1|填充对齐，用于将后续选项对齐到4字节边界。|握手/数据|
|2|​**Maximum Segment Size (MSS)​**​|4|通告本端**能够接收**的TCP段的最大数据量。|​**SYN**​|
|3|​**Window Scale**​|3|通过左移位数来扩大通告窗口的倍数，解决高速网络下窗口大小65535字节的限制。|​**SYN**​|
|4|​**Selective ACK Permitted (SACK-Permitted)​**​|2|在SYN段中发送，告知对方本端支持**选择性确认(SACK)​**​ 功能。|​**SYN**​|
|5|​**Selective ACK (SACK)​**​|可变|在数据传送阶段，用于通知发送方哪些**不连续的数据块**已经收到，极大提升重传效率。|数据|
|8|​**Timestamps (TSval / TSecr)​**​|10|1. ​**计算往返时间**​ 2. ​**防止序列号回绕**。对高速网络至关重要。|全程|
|28|​**User Timeout**​|4|通告本端的TCP用户超时参数，指示等待未确认数据多久后应放弃连接。|​**SYN**​|
|29|​**Authentication (TCP-AO)​**​|可变|提供比旧的MD5签名更强大的TCP段认证，用于增强BGP等协议的安全性。|全程|

#### 2. 关键选项工作原理

 ##### **MSS协商**​

在三次握手的SYN段中，双方都会通告自己的MSS值。连接的最终MSS取两者中的较小值。这确保了双方都不会发送超过对方接收能力的TCP段，从而避免在路径上被IP分片，降低传输效率。

![[Pasted image 20250920154839.png]]

​
##### 窗口缩放​

TCP头部中的`窗口大小`字段只有16位，最大值为65535字节。这在高速网络（如千兆、万兆网）中会成为瓶颈。窗口缩放选项通过在SYN段中协商一个缩放因子（shift count）来解决此问题。

- 例如，窗口缩放因子为 `3`，那么实际的窗口大小 = 通告窗口值 * 2³ = 通告窗口值 * 8。
    
- 这使得实际窗口大小最高可达 65535 * 65535（因子最大14位），足以满足高速网络需求。
    
##### 选择性确认​

没有SACK时，TCP使用累积确认（如ACK 1001表示收到了1000及之前的所有字节）。如果段2和段4丢失，收到段3和段5后，接收方只能重复发送ACK 1001（对段2的确认），这会导致发送方重传段2及之后的所有数据（段2,3,4,5），即**回退N步重传**。
>**累积确认号**ACK的含义：**我已经成功按序收到了所有直到`[ACK号 - 1]` 的字节，我期望的下一个字节序列号是 `[ACK号]` 这个ACK号定义了一个“缺口”的**左边界**
 
在SYN阶段启用SACK（允许选择性确认）后，接收方可以在数据传输过程中的ACK中告诉发送方：“我已经收到了段3和段5的数据块”(指出在缺口之后已经成功接收的**数据块范围**​)。发送方因此知道只需要重传**段2**和**段4**即可。这极大地提高了重传效率，在高丢包率网络中性能提升显著。

1. ​**标准ACK号**​：​**仍然保持 `ACK = 1001`**。因为缺口最左边的段2依然没收到，所以期望的序列号不变。
    
2. ​**更新SACK选项**​：现在它收到了两个不连续的数据块（段3和段5），所以它会在SACK选项中包含**多个块**来描述所有已知的接收数据。
    
    - `SACK Block 1: [2001, 3001)`（段3）
        
    - `SACK Block 2: [4001, 5001)`（段5）
    
##### 时间戳
​

该选项包含两个字段：

- ​**TSval**​：发送方放置的时间戳值。
    
- ​**TSecr**​：回显对方的时间戳值（类似ACK机制）。
    
    其作用：
    
    1. ​**计算RTT**​：发送方在数据段中放入TSval。接收方在ACK段中原样返回这个TSval（放在TSecr里）。发送方用当前时间减去TSecr，就能得到非常精确的RTT样本，而无需重传定时器参与。
        
    2. ​**防止序列号回绕**​：在极高速的网络中（如10Gbps+），序列号可能会在很短的时间内被重复使用。时间戳提供了额外的上下文来区分相同序列号的不同数据实例，防止旧段被误认为是新段。
        
    

---

### 选项的排列与填充

TCP选项必须遵循以下规则：

1. ​**顺序**​：所有选项必须紧接在标准TCP头部之后。
    
2. ​**对齐**​：某些选项（如Timestamps）要求其起始位置是4字节的倍数。为了实现这种对齐，需要在前面填充**NOP**选项。
    
3. ​**结束**​：整个选项列表的末尾必须由 ​**EOL**​ 选项标识。
    

​**示例选项排列：​**​

```
[20字节标准头部] [NOP] [NOP] [MSS Kind=2, Length=4, Value=1460] [Window Scale Kind=3, Length=3, Value=7] [SACK-Permitted Kind=4, Length=2] [NOP] [NOP] [Timestamps Kind=8, Length=10, TSval, TSecr] [EOL]
```

（这里使用NOP来将Timestamps选项对齐到4字节边界）。

### 总结

TCP选项是TCP协议实现其**可靠性、高效性和可扩展性**的核心机制之一。它们允许TCP在基本框架不变的情况下，通过协商不断引入新的增强功能。通过Wireshark等抓包工具，你可以清晰地看到三次握手和数据包中这些选项的具体内容，这对于理解和调试网络问题非常有帮助。