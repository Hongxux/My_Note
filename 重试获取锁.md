---
aliases:
  - 重试获取
---
![[重试获取锁 2025-11-19 19.40.36.excalidraw]]
核心:
1. 维护了剩余可用时间time，和上次记录的时间current
	- 更新时机:
		- 初次尝试之后
		- 订阅锁
		- 循环重试（while（true））的时候
			- 每次尝试获取锁之后
			- 每次等待锁释放信号之后
	- 更新方式：time -=System.currenttimeMill()-current
		- System.currenttimeMill()-current表示某个操作用去的时间
	- 更新的目的：当剩余可用时间time<=0之后退出，取消重试
2. 订阅机制和等待机制：**订阅一个特定的Redis频道，监听当前锁被释放的消息**
	- **等待机制：**
		- 最长等待时间的选择：在等待信号时，Redisson会判断当前锁的剩余存活时间（TTL）。如果TTL小于剩余的等待时间，则等待时间设置为TTL，这意味着它最多只会在当前锁持有者释放锁时被唤醒。
		```
		if (ttl >= 0 && ttl < time) {
		            // 等待时间取“锁剩余存活时间”和“剩余等待时间”的较小值
		            getEntry(threadId).getLatch().tryAcquire(ttl, TimeUnit.MILLISECONDS);
		        } else {
		            getEntry(threadId).getLatch().tryAcquire(time, TimeUnit.MILLISECONDS);
		        }
		```
		- 唤醒时机：信号量尝试等待又两种情况会被唤醒
			- 一是超过了自己设置的最长等待时间（time或者ttl）
			- 二是成功收到通知（有人释放锁并且publish）
	- **[[重试获取锁的订阅发布机制|订阅机制]]**： 通过“订阅-发布-响应”模式，线程从主动的、频繁的轮询询问（"锁释放了吗？"）转变为被动的通知等待（"锁释放了请告诉我"）。这极大地减轻了Redis服务器的压力，也减少了网络开销。


