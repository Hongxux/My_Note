![[Pasted image 20251118140435.png]]
 - **做法**：
    1. **初始化**：**组合使用动态更新和定时同步**
	    1.  **全量初始化**：系统启动时，将当前所有已上架的商品ID加载到布隆过滤器中。适用于商品库相对稳定的情况。
		2. **动态更新**：当有新商品上架时，通过一个消息队列或直接调用一个服务，**实时地将新商品ID添加到布隆过滤器**。这是更优的方案。
		3. **定时同步**：还有一个兜底方案，可以有一个定时任务，定期（比如每天凌晨）从数据库同步全量商品ID到布隆过滤器，用于纠正可能的遗漏。
    2. **查询流程**：当请求到来时，先查询布隆过滤器。
        
        - 如果布隆过滤器说 **“一定不存在”**，则直接返回空结果，无需查询缓存和数据库。
            
        - 如果布隆过滤器说 **“可能存在”**，再继续执行正常的缓存查询流程。
	        - **为什么是“可能存在”**：因为不同ID的哈希值可能会发生冲突(哈希冲突)。当位数组变得很满时，误判率会升高。但**它绝不会误判“不存在”的情况**。这正是我们防穿透需要的特性——把“肯定不存在”的请求果断拦截掉。

- **原理：**
	- 布隆过滤器本质是一个很大的位数组（bitmap）和多个哈希函数。
		- **添加**一个商品ID时，会用多个哈希函数计算出多个位置，把这些位置置为1。
		- **查询时**，同样用这些函数计算位置，如果**所有位置都是1**，则说“可能存在”；如果**任何一个位置是0**，则说“肯定不存在”。
- **优点**：
    - 内存占用极少.没有多余空值key
    - 从根本上解决了问题，恶意攻击请求在布隆过滤器层就被拦截。
- **缺点**：
    
    - 存在一定的误判率
        - 存在的数据不一定存在
		 - 不存在的数据一定不存在
    - 需要维护布隆过滤器的数据，当数据库有新增数据时需要及时更新过滤器。
