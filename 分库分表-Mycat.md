---
aliases:
  - 分库分表
  - Mycat
---
## 介绍

将单一的数据库分库分表到多个数据库，从而分散对数据库的访问
### 一、 问题分析：单体数据库的性能瓶颈

当数据量和访问量激增时，单体数据库的两个核心瓶颈：
#### 1. IO瓶颈（数据存取瓶颈）

- ​**根源**​：数据量远超内存容量。
- ​**表现**​：
    - ​**热点数据多**​：频繁访问的数据（热点）无法全部缓存在内存中，导致大量请求需要直接读写磁盘，速度极慢。
    - ​**带宽不足**​：巨大的数据吞吐量导致网络IO成为瓶颈。
#### 2. CPU瓶颈（数据处理瓶颈）

- ​**根源**​：复杂的计算和高并发的请求。
- ​**表现**​：
    - ​**复杂查询**​：`ORDER BY`、`GROUP BY`、多表`JOIN`、`DISTINCT`等操作会消耗大量CPU资源。
    - ​**高并发请求**​：每秒处理的事务数（TPS）和查询数（QPS）达到单机CPU处理上限，导致CPU使用率100%，响应时间急剧上升。
​**结论**​：当数据库达到瓶颈时，简单的硬件升级（垂直扩展）成本高昂且收效甚微，必须采用**架构上的水平扩展**。

### 二、 解决方案：分库分表的中心思想

图2精辟地总结了解决上述问题的根本途径：

> ​**分库分表的中心思想都是将数据分散存储，使得单一数据库/表的数据量变小来缓解单一数据库的性能问题，从而达到提升数据库性能的目的。​**​

#### 一、 拆分策略详解

##### 1. 垂直拆分 - 按列拆分

​**核心思想**​：基于业务或字段属性，以“列”为单位进行拆分，遵循“专库专用、专表专用”的原则。

- ​**垂直分库**​
	    ![[Pasted image 20251104104416.png]]
    - ​**做法**​：​**以表为依据，根据业务将不同表拆分到不同库中。​**​
        
    - ​**示例**​：将一个包含用户、订单、商品等模块的“大而全”的数据库，拆分成独立的**用户库**、**订单库**、**商品库**。
        
    - ​**价值**​：
        
        - ​**业务解耦**​：不同业务的数据独立，便于管理和维护。
            
        - ​**负载隔离**​：避免不同业务争抢数据库资源，相互影响。
            
        
    
- ​**垂直分表**​
	    ![[Pasted image 20251104104618.png]]
    - ​**做法**​：将一个字段过多的“大宽表”，按字段的访问频次或业务关联性拆分成多个子表。
        
    - ​**示例**​：将`用户表`拆分成`用户基础表`（UID, 姓名, 手机号等高频访问字段）和`用户详情表`（地址, 个人简介等低频访问字段）。
        
    - ​**价值**​：
        
        - ​**提升热点数据效率**​：核心业务字段查询更快。
            
        - ​**避免IO浪费**​：避免读取不必要的大字段（如TEXT）造成的IO性能瓶颈。
            
        
    

##### 2. 水平拆分 - 按行拆分

​**核心思想**​：将一张表中的数据，按照某种规则（如取模、范围、哈希）分散到多个结构相同的库或表中。​**这是解决海量数据问题的终极方案。​**​

- ​**水平分库​**​
	    ![[Pasted image 20251104104732.png]]
    - ​**做法**​：​**以字段为依据，按照一定策略，将一个库的数据拆分到多个库中。​**​
        
    - ​**特点**​：
        
        1. 每个库的**表结构都一样**。
            
        2. 每个库的**数据都不一样**。
            
        3. 所有库的**并集是全量数据**。
            
        
    - ​**示例**​：将`订单表`的数据按`用户ID`取模，分散到3个不同的数据库实例中。
        
    
- ​**水平分表​**​
	    ![[Pasted image 20251104104806.png]]
    - ​**做法**​：​**以字段为依据，按照一定策略，将一个表的数据拆分到多个表中。​**​（这多个表可以在同一个库内）。
        
    - ​**特点**​：与水平分库类似，每个表结构相同，数据不同，所有表的并集是全量数据。
        
    - ​**示例**​：在同一个数据库内，将`订单表`拆分成`order_001`, `order_002`, ..., `order_999`共1000张表。
        
    

​**水平拆分的共同价值**​：

- ​**解决存储瓶颈**​：单库单表的数据量得到控制。
    
- ​**提升并发性能**​：读写负载被分摊到多个数据库或数据表上。
    

#### 二、 技术实现方案

分库分表在应用层实现起来非常复杂，通常借助中间件。图片介绍了两种主流方案：

| 方案                   | 模式                | 优点                                    | 缺点                            | 适用场景                         |
| -------------------- | ----------------- | ------------------------------------- | ----------------------------- | ---------------------------- |
| ​**Sharding-JDBC​**​ | ​**客户端中间件**​      | ​**性能高**​（无代理层网络开销），与Java应用集成度高，功能强大。 | ​**代码侵入性强**，需在应用中配置，仅支持Java。  | 对性能要求极高的Java技术栈项目。           |
| ​**MyCat​**​         | ​**服务端中间件（代理）​**​ | ​**对应用透明**，无需修改代码，支持多种语言。​**易于管理**。   | ​**性能有损耗**​（多一层网络跳转），有单点瓶颈风险。 | 多语言技术栈、希望快速上线、对绝对性能要求不极致的场景。 |


#### 三、 选择建议

1. ​**拆分顺序**​：通常先进行**垂直拆分**​（分库），进行业务梳理和解耦；当单库数据量或并发量仍然巨大时，再对核心表进行**水平拆分**。
    
2. ​**技术选型**​：
    
    - 追求**极致性能**和**精细化控制**，团队技术实力强，选 ​**Sharding-JDBC**。
        
    - 追求**快速实施**、**多语言支持**和**运维便利性**，选 ​**MyCat**。
        
    
3. ​**引入挑战**​：分库分表引入了分布式事务、跨库查询、全局主键生成、数据迁移等复杂性，需要谨慎评估和设计。
    

#### 四、 分库分表带来的新挑战

分库分表在提升性能的同时，也引入了新的技术复杂性，需要在设计时充分考虑：

1. ​**分布式事务问题**​：数据分布在多个库，如何保证跨库事务的ACID特性？通常需要引入柔性事务或分布式事务中间件。
    
2. ​**跨库关联查询**​：原本简单的`JOIN`查询变得异常困难，需要在应用层进行多次查询合并，或采用全局索引。
    
3. ​**全局主键唯一性**​：在多个数据库上，如何生成唯一、单调递增的ID？常用方案有雪花算法、UUID、号段模式等。
    
4. ​**数据迁移与扩容**​：如何平滑地进行数据重新分片和库实例扩容？需要精心的规划和工具支持。
    
## Mycat
![[Pasted image 20251104111114.png]]
### Mycat概述

### Mycat配置
### Mycat分片
### Mycat管理及监控