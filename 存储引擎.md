### MySQL体系结构
![[Pasted image 20251029164332.png]]

MySQL的架构采用了一种独特的、基于插件的存储引擎设计，这使得它非常灵活和高效。各层级之间协同工作，共同处理一条SQL请求。

---

#### 1. 连接层

这是最上层，负责与客户端打交道。

- ​**职责**​：
    
    - ​**连接处理**​：管理客户端的连接（如线程处理、连接池）。
        
    - ​**授权认证**​：验证用户名、密码以及主机权限。
        
    - ​**安全方案**​：提供SSL加密等安全支持。
        
    
- ​**好比**​：公司的前台或门卫，负责接待来访者并核实其身份。
    

#### 2. 服务层 （也称为 SQL Layer）

这是MySQL的“大脑”，负责核心的逻辑处理。​**这一层是跨存储引擎的**，意味着无论底层使用哪种存储引擎，这些功能都是一致的。

- ​**核心组件与功能**​：
    
    - ​**SQL接口**​：接收并处理SQL命令（如DML、DDL）。
        
    - ​**查询缓存**​（在MySQL 8.0中已移除）：缓存SELECT语句及其结果集。
        
    - ​**解析器**​：对SQL语句进行词法和语法分析，生成解析树。
        
    - ​**查询优化器**​：​**非常重要**。它对SQL语句进行优化，生成它认为最有效的执行计划（例如，决定使用哪个索引，表的连接顺序等）。
        
    - ​**内置函数**​：执行日期、数学、加密等内置函数。
        
    - ​**存储过程、触发器、视图**​：这些跨引擎的功能都在这一层实现。
        
    

#### 3. 引擎层

这是MySQL最具特色的部分，架构设计上的精髓所在。​**存储引擎负责数据的实际存储和读取**。

- ​**工作模式**​：服务层通过定义好的API与存储引擎通信，这些API屏蔽了不同引擎的差异。
    
- ​**核心特点**​：​**可插拔性**。你可以为不同的表根据其应用场景（如需要事务支持、需要极高的插入性能）选择最合适的存储引擎。
    
- ​**常见存储引擎**​：
    
    - ​**InnoDB**​：​**MySQL 5.5.8之后的默认引擎**。支持**事务**、行级锁、外键约束，是提供提交、回滚、崩溃恢复能力的事务安全型引擎。
        
    - ​**MyISAM**​：MySQL 5.5.8之前的默认引擎。不支持事务和外键，但访问速度快，适合读多写少、不需要事务支持的场景。
        
    

#### 4. 存储层

这是数据的最终存放地，所有数据（表、索引等）都以文件的形式存储在服务器的文件系统上。

- ​**职责**​：存储引擎会调用文件系统接口，完成数据的物理读写（如`.ibd`文件用于InnoDB，`.MYD`和`.MYI`文件用于MyISAM）。
    

#### 总结与工作流程

这张图的关键在于理解**服务层与引擎层的分离**。当执行一条SQL语句时：

1. ​**连接层**验证你的身份并建立连接。
    
2. ​**服务层**对你的SQL进行解析、优化，确定执行方案。
    
3. ​**服务层**调用**引擎层**的API，告诉它“我要读取这些数据”。
    
4. ​**引擎层**根据指令，在**存储层**的文件系统中进行实际的读写操作。
    
5. 引擎层将获取的数据返回给服务层，服务层再做最后处理（如分组、排序）后，将结果返回给客户端。
    

这种设计使得MySQL在保持SQL接口统一的同时，底层存储可以灵活多变，以适应各种不同的业务需求。
### 存储引擎简介
​**核心概念**​：存储引擎是数据库底层软件组件，​**负责数据的存储、读取、索引管理和事务处理**。MySQL 的一个核心特性就是其**可插拔的存储引擎架构**。
- 存储引擎的对象是表，不是数据库
#### 如何查看和设置存储引擎

1. ​**查看当前服务器支持的存储引擎：​**​
    
    ```
    SHOW ENGINES;
    ```
    
2. ​**查看特定表的存储引擎：​**​
    
    ```
    SHOW TABLE STATUS LIKE 'table_name';
    ```
    
3. ​**创建表时指定存储引擎：​**​
    
    ```
    CREATE TABLE my_table (
        id INT PRIMARY KEY,
        name VARCHAR(100)
    ) ENGINE=InnoDB; -- 指定使用 InnoDB 引擎
    ```
    
4. ​**修改已存在表的存储引擎：​**​
    
    ```
    ALTER TABLE my_table ENGINE = InnoDB;
    ```
    

#### 总结与建议

- ​**InnoDB**​：​**默认且首选**。除非有非常特殊的理由，否则都应使用 InnoDB。它提供了事务安全、行级锁和外键支持，是现代应用不可或缺的特性，能很好地平衡高并发下的性能和可靠性。
    
- ​**MyISAM**​：​**逐渐被淘汰**。由于其不支持事务和行级锁，在并发写操作时性能很差，且崩溃后表容易损坏。仅在非核心的、只读的归档或报表场景中可考虑使用。
    
- ​**Memory**​：​**特殊用途**。将所有数据存储在内存中，速度极快，但服务器重启后数据会丢失。适用于临时存储中间结果或做高速缓存。
    

​**核心思想**​：MySQL 的可插拔存储引擎架构让你可以根据**业务需求**​（是否需要事务？读多还是写多？对数据安全性要求多高？）来为不同的表选择最合适的“发动机”，从而实现最佳的性能和功能。


### 存储引擎核心特点

存储引擎决定了数据如何被存储、索引以及支持哪些功能（如事务、外键），可以理解为数据库的“发动机”。下表是图中内容的清晰总结：

|特点|InnoDB|MyISAM|Memory|
|---|---|---|---|
|​**存储限制**​|64TB|有（256TB）|受RAM限制|
|​**事务安全**​|​**支持**​|不支持|不支持|
|​**锁机制**​|​**行级锁**​|表级锁|表级锁|
|​**B+tree索引**​|支持|支持|支持|
|​**Hash索引**​|不支持|不支持|​**支持**​|
|​**全文索引**​|支持（5.5版本后）|​**支持**​|不支持|
|​**空间使用**​|高|低|N/A（内存中）|
|​**内存使用**​|高|低|中等|
|​**批量插入速度**​|低|​**高**​|​**高**​|
|​**支持外键**​|​**支持**​|不支持|不支持|

---

### 引擎选型

根据以上对比，我们可以得出以下结论：

#### 1. InnoDB：​**默认且首选**​

- ​**核心优势**​：提供**事务安全**​（ACID）和**行级锁**，支持**外键约束**。这保证了数据的完整性和一致性，并在高并发写操作下性能优异。
    
- ​**适用场景**​：​**绝大多数的应用场景**。只要是涉及交易、支付、用户数据等需要确保数据准确无误的场合，都应使用InnoDB。
    
- ​**代价**​：为了实现高可靠性，其在空间占用、内存消耗和批量插入速度上会有所牺牲。
    

#### 2. MyISAM：​**特定只读场景**​

- ​**核心优势**​：​**空间占用低**，​**批量插入和读取速度非常快**。支持全文索引。
    
- ​**致命弱点**​：​**不支持事务**和**行级锁**。写操作会对整张表加锁，并发性能差。崩溃后表易损坏。
    
- ​**适用场景**​：​**只读或读远大于写的场景**，如数据仓库、报表分析、日志记录等。​**在现代Web应用中已不推荐使用**。
    

#### 3. Memory：​**极速临时存储**​

- ​**核心优势**​：所有数据置于**内存**中，速度极快。支持Hash索引，等值查询性能超高。
    
- ​**致命弱点**​：​**服务器重启或崩溃后，所有数据丢失**。使用表级锁。
    
- ​**适用场景**​：​**临时表**、**缓存**​（如存储会话信息）、或存放中间计算结果等**可丢失的非核心数据**。
    
