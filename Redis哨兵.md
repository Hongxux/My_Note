- 需求背景：主从复制架构中，主节点故障后，**需要手动干预**将从节点提升为主节点
	- **恢复时间过长（分钟/小时级）**，运维复杂
- 解决措施：哨兵机制
	- **自动检测主节点故障**
	- **完成自动故障转移**
	- **通知**其他从节点复制新的主节点
- 布置哨兵要求：
	- **至少三个**（推荐奇数个，如3或5个）哨兵节点
		- 目的：判断下线
	- 将它们分布在不同的物理机、机架或可用区（AZ）上
		- 目的：避免因单个硬件或机房故障导致哨兵集群本身瘫痪
- 风险：
	- 脑裂风险
		- 含义：集群中同时存在两个可写的主节点
		- 状态的形成：
			1. 主节点和哨兵集群之间的网络发生严重延迟或完全中断
			2. 哨兵集群可能因无法与主节点通信而判定其下线，并选举出一个新的主节点。
			3. 原主节点可能并未真正故障，仍在对外提供服务
		- 后果：造成数据严重不一致
	- 数据丢失风险
		- 原因：Redis主从复制默认是**异步**的，如果在数据同步到从节点之前主节点发生故障，这部分数据就会永久丢失
		- 缓解措施：
			- 权衡一致性与性能：
				- 适用场景：无法承受数据丢失的业务
				- 缓解方式：在写操作时使用 `WAIT`命令：要求主节点等待数据复制到指定数量的从节点后再返回成功
				- 问题 ：会显著影响性能和可用性
			- 持久化与备份：结合AOF和RDB持久化策略，并建立定期备份机制，作为最后的数据恢复手段。
	- 运行多个哨兵进程和从节点也会消耗额外的系统资源

---
实现原理
1. 监控
	- 含义:持续检查主、从节点是否正常运行。
	- 实现机制:
		- 主观下线:如果某一个sentinel节点发现某实例未在规定时间响应，则认为该实例主观下线。![[Pasted image 20251123134959.png]]
		- 客观下线:若超过指定数量(quorum)的sentinel都认为该实例主观下线，则该实例客观下线。![[Pasted image 20251123134948.png]]
			- quorum是配置项,quorum值最好超过Sentinel实例数量的一半。
2. 自动故障转移，选择新的主节点
	- 含义:主节点故障时，自动将从节点提升为主节点，并让其他从节点复制新主节点。
	- 实现机制:使用Raft协议在哨兵实例间选举领导哨兵，由它执行故障转移操作。
		- 选择依据:
			1. 排除数据过久的从节点:
				- 判断slave节点与master节点断开时间长短，如果超过指定值(down-after-milliseconds*10)则会排除该
			2. 根据从节点的优先级选择
				- 判断slave节点的slave-priority值，越小优先级越高
					- 如果是0则永不参与选举
			3.  优先选择数据新的
				- 判断slave节点的offset值，越大说明数据越新，优先级越高
			4. 最后根据runid(随便选一个)
				- 判断slave节点的运行id大小，越小优先级越高。
		- 将从节点提升为主节点的方式：执行slaveof no one命令
3. 配置和通知
	- 含义:作为**服务发现**的权威源，客户端可查询哨兵以获取当前有效的主节点地址。
	- 实现步骤:![[Pasted image 20251123135729.png]]
		1. sentinel给所有其它slave发送slaveof 192.168.150.101 7002
		命令，让这些slave成为新master的从节点，开始从新的master
		上同步数据。
		2. 最后，sentinel将故障节点标记为slave，当故障节点恢复后会自
		动成为新的master的slave节点
---

### 哨兵搭建
在一台RockyLinux虚拟机上搭建redis 的哨兵集群，我现在有一个主主节点，端口号为6379，两个从节点，端口号分别为6380,6381，ip地址都为192.168.0.100


#### 🔧 环境准备与节点规划

首先，确保您的RockyLinux虚拟机已安装必要的编译工具。然后规划节点，由于所有服务都部署在同一台机器（IP: 192.168.0.100）上，我们需要通过端口号来区分它们。

|角色|IP地址|端口|说明|
|---|---|---|---|
|**Redis Master**​|192.168.0.100|6379|主节点，负责写操作|
|**Redis Slave-1**​|192.168.0.100|6380|从节点1，复制主节点数据|
|**Redis Slave-2**​|192.168.0.100|6381|从节点2，复制主节点数据|
|**Sentinel-1**​|192.168.0.100|26379|哨兵实例1，监控Redis节点|
|**Sentinel-2**​|192.168.0.100|26380|哨兵实例2，监控Redis节点|
|**Sentinel-3**​|192.168.0.100|26381|哨兵实例3，监控Redis节点|

#### 🛡️ 配置哨兵集群

哨兵集群由三个哨兵实例（26379, 26380, 26381）组成，它们共同监控Redis主从节点。

1. **哨兵配置文件**:
    
    为每个哨兵实例创建配置文件，例如 `sentinel_26379.conf`。核心配置如下：
    
    ```
    # sentinel_26379.conf
    port 26379
    daemonize yes
    pidfile /var/run/redis-sentinel_26379.pid
    logfile "/var/log/redis/sentinel_26379.log"
    dir "/tmp/26379"  # 哨兵工作目录
    
    # 核心指令：监控名为mymaster的主节点，IP为192.168.0.100，端口6379。
    # 数字2表示当至少2个哨兵认为主节点不可用时，才判定为"客观下线"并触发故障转移。
    sentinel monitor mymaster 192.168.0.100 6379 2
    
    # 主节点密码
    #sentinel auth-pass mymaster your_strong_password_here
    
    # 主节点失联30000毫秒（30秒）后，哨兵将其标记为"主观下线"
    sentinel down-after-milliseconds mymaster 30000
    
    # 故障转移超时时间（180秒）
    sentinel failover-timeout mymaster 180000
    
    # 执行故障转移后，每次向新主节点同步数据的从节点数量（设为1通常更稳定）
    sentinel parallel-syncs mymaster 1
    ```
    
    将上述配置复制给 `sentinel_26380.conf`和 `sentinel_26381.conf`，并修改其中的端口号、pid文件、日志文件路径，确保每个哨兵实例使用不同的配置。
    
2. **启动哨兵**:
    
    ```
    redis-sentinel /path/to/sentinel_26379.conf
    redis-sentinel /path/to/sentinel_26380.conf
    redis-sentinel /path/to/sentinel_26381.conf
    ```
    
3. **验证哨兵**:
    
    连接任意一个哨兵实例，查看监控状态：
    
    ```
    redis-cli -h 192.168.0.100 -p 26379
    127.0.0.1:26379> info sentinel
    ```
    
    在输出中，应看到 `sentinel_masters:1`且 `master0`的状态为 `status=ok`，`sentinels=3`（表示三个哨兵都已被识别）。
    

#### 🧪 测试故障转移

现在可以模拟主节点故障，观察哨兵是否能自动完成故障转移。

1. **模拟主节点宕机**：通过 `redis-cli`连接主节点（6379），执行 `DEBUG SLEEP 30`或直接使用 `SHUTDOWN`命令停止该实例服务。
    
2. **观察哨兵日志**：查看任意哨兵实例的日志文件（如 `sentinel_26379.log`）。您应该能看到类似 `+switch-master`的日志条目，指示已经将某个从节点（如6380）提升为新的主节点。
    
3. **验证拓扑**：故障转移后，使用 `info replication`命令检查新的主节点（6380），确认其 `role`已变为 `master`，并且另一个节点（6381）已将其复制源切换至新的主节点。原主节点（6379）恢复后，应自动以从节点身份重新加入集群。
    

### RedisTemplate的哨兵模式
在Sentinel集群监管下的Redis主从集群，其节点会因为自动故障转移而发生变化，Redis的客户端必须感知这种变化
及时更新连接信息。Spring的RedisTemplate底层利用lettuce实现了节点的感知和自动切换。![[Pasted image 20251124093738.png]]
![[Pasted image 20251124093810.png]]RedisTemplate底层通常使用Lettuce或Jedis（较新版本Spring Boot默认使用Lettuce）作为Redis客户端连接库。它们通过以下机制实现自动感知：

1. **服务发现**：启动时，客户端根据配置的哨兵节点列表，**连接到哨兵集群**，并查询当前名为 `mymaster`的主节点实际地址。
2. **事件监听**：客户端会**订阅哨兵频道**。当发生故障转移（如主节点切换）时，哨兵会向特定频道发布消息。
3. **连接更新**：客户端监听到这些消息后，**自动断开与旧主节点的连接**，并**重新向哨兵查询新的主节点地址**，然后建立新连接。这个过程对应用程序是透明的。