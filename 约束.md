### 概述

#### 1. 概念

约束是作用于表中字段上的规则，用于限制存储在表中的数据。

#### 2. 目的

保证数据库中数据的正确、有效性和完整性。

#### 3. 分类

| 约束               | 描述                           | 关键字         |
| ---------------- | ---------------------------- | ----------- |
| 非空约束             | 限制该字段的数据不能为null              | NOT NULL    |
| 唯一约束             | 保证该字段的所有数据都是唯一、不重复的          | UNIQUE      |
| 主键约束             | 主键是一行数据的唯一标识，要求非空且唯一         | PRIMARY KEY |
| 默认约束             | 保存数据时，如果未指定该字段的值，则采用默认值      | DEFAULT     |
| 检查约束(8.0.16版本之后) | 保证字段值满足某一个条件                 | CHECK       |
| 外键约束             | 用来让两张表的数据之间建立连接，保证数据的一致性和完整性 | FOREIGN KEY |

#### 使用
![[Pasted image 20251029092423.png]]
```
create table user(
    id int primary key auto_increment comment '主键',
    name varchar(10) not null unique comment '姓名',
    age int check ( age > 0 && age <= 120) comment '年龄',
    status char(1) default '1' comment '状态',
    gender char(1) comment '性别'
) comment '用户表';
```

```
-- 为用户表添加多个约束
ALTER TABLE users 
ADD PRIMARY KEY (user_id),
ADD CONSTRAINT uk_email UNIQUE (email),
ADD CONSTRAINT chk_age CHECK (age >= 18),
MODIFY username VARCHAR(50) NOT NULL,
MODIFY created_at DATETIME DEFAULT CURRENT_TIMESTAMP;

-- 为订单表添加外键约束
ALTER TABLE orders 
ADD CONSTRAINT fk_orders_users 
FOREIGN KEY (user_id) REFERENCES users(user_id)
ON DELETE CASCADE;
```

|字段定义|组件分解|含义与作用|
|---|---|---|
|​**`id int`**​|`id`|字段名|
||`int`|数据类型：整数|
||`primary key`|​**约束**​：主键，唯一标识每一行记录|
||`auto_increment`|​**约束**​：自动增长，新增记录时无需指定，值自动+1|
||`comment '主键'`|字段注释，说明其用途|
|​**`name varchar(10)`**​|`name`|字段名|
||`varchar(10)`|数据类型：可变长度字符串，最大10个字符|
||`not null`|​**约束**​：非空，此字段必须填写，不能为NULL|
||`unique`|​**约束**​：唯一，该字段的值在全表不能重复|
|​**`age int`**​|`age`|字段名|
||`int`|数据类型：整数|
||`check (age > 0 && age <= 120)`|​**约束**​：检查约束，值必须满足`0 < age <= 120`的条件|
|​**`status char(1)`**​|`status`|字段名|
||`char(1)`|数据类型：固定长度字符串，长度为1|
||`default '1'`|​**约束**​：默认值，如果插入数据时未指定值，则默认为`'1'`|
|​**`gender char(1)`**​|`gender`|字段名|
||`char(1)`|数据类型：固定长度字符串，长度为1|
||（无约束）|此字段没有任何约束，可以为空，也可以重复|

### 外键约束
用来让两张表的数据之间建立连接，保证数据的一致性和完整性
![[Pasted image 20251029093438.png]]
- **建立关联**​：连接两张表，使子表的外键字段引用主表的主键。
    
- ​**数据完整性**​：防止无效数据（如子表引用不存在的记录）。
    
- ​**级联操作**​：可配置自动更新或删除关联数据（如删除主表记录时同步删除子表记录）。
#### 建立外键关联

##### 1. 创建表时直接添加外键

​**语法结构：​**​

```
CREATE TABLE 子表名 (
    字段1 数据类型 PRIMARY KEY,
    字段2 数据类型,
    ...
    [CONSTRAINT 外键名称] 
        FOREIGN KEY (子表外键字段) 
        REFERENCES 主表名(主表字段)
);
```

​**示例：​**​

```
CREATE TABLE orders (
    order_id INT PRIMARY KEY,
    user_id INT,
    amount DECIMAL(10,2),
    CONSTRAINT fk_user 
        FOREIGN KEY 
        (user_id) REFERENCES users(id)  -- 关联users表的主键id
);
```

​**关键说明：​**​

- `[CONSTRAINT 外键名称]`：可选，省略时系统自动生成名称。
    
- `REFERENCES`：指定被引用的主表及字段。
    

##### 2. 修改现有表添加外键

​**语法结构：​**​

```
ALTER TABLE 子表名 
ADD CONSTRAINT 外键名称 
    FOREIGN KEY (子表外键字段) 
    REFERENCES 主表名(主表字段);
```

​**示例：​**​

```
-- 为已存在的orders表添加外键
ALTER TABLE orders 
ADD CONSTRAINT fk_user 
    FOREIGN KEY (user_id) 
    REFERENCES users(id);
```

##### 3.外键约束删除、更新行为
| 行为                | 说明                                     | 适用场景        |
| ----------------- | -------------------------------------- | ----------- |
| ​**NO ACTION**​   | 父表删除/更新时检查外键引用，存在引用则拒绝操作（与RESTRICT一致）  | 严格数据完整性保护   |
| ​**RESTRICT**​    | 父表删除/更新时检查外键引用，存在引用则拒绝操作（与NO ACTION一致） | 默认安全策略      |
| ​**CASCADE**​     | 父表删除/更新时，同步删除/更新子表对应记录                 | 级联删除关联数据    |
| ​**SET NULL**​    | 父表删除时，将子表外键值设为NULL（要求外键字段允许NULL）       | 保留子表记录但解除关联 |
| ​**SET DEFAULT**​ | 父表变更时，子表外键列设为默认值（InnoDB不支持）            | 理论设计，实际限制   |
1. **CASCADE 示例（级联删除）**

```
-- 用户表删除用户时，自动删除其所有订单
ALTER TABLE orders 
ADD CONSTRAINT fk_user 
    FOREIGN KEY (user_id) 
    REFERENCES users(id)
    ON DELETE CASCADE;
```

2. **SET NULL 示例（置空处理）**

```
-- 部门表删除部门时，员工表的部门ID设为NULL
ALTER TABLE employees 
ADD CONSTRAINT fk_department 
    FOREIGN KEY (dept_id) 
    REFERENCES departments(id)
    ON DELETE SET NULL;
```

3. **RESTRICT/NO ACTION 示例（禁止操作）**

```
-- 有订单的用户不允许删除
ALTER TABLE orders 
ADD CONSTRAINT fk_user 
    FOREIGN KEY (user_id) 
    REFERENCES users(id)
    ON DELETE RESTRICT;
```
##### 三、完整示例场景

假设有两张表：

- ​**主表**​ `users`：存储用户信息，有主键 `id`
    
- ​**子表**​ `orders`：存储订单，需关联用户
    

```
-- 创建主表
CREATE TABLE users (
    id INT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(50) NOT NULL
);

-- 创建子表时添加外键
CREATE TABLE orders (
    id INT PRIMARY KEY AUTO_INCREMENT,
    user_id INT,
    order_date DATE,
    CONSTRAINT fk_order_user 
        FOREIGN KEY (user_id) 
        REFERENCES users(id)
);

-- 或后期修改添加（若表已存在）
ALTER TABLE orders 
ADD CONSTRAINT fk_order_user 
    FOREIGN KEY (user_id) 
    REFERENCES users(id);
```

##### 四、注意事项

1. ​**字段类型必须匹配**​：外键字段和主表字段的数据类型需完全一致。
    
2. ​**索引优化**​：外键字段会自动创建索引，提高关联查询效率。
    
3. ​**删除/更新行为**​：可 扩展语法定义级联操作：
    
    ```
    FOREIGN KEY (user_id) 
    REFERENCES users(id)
    ON DELETE CASCADE  -- 主表删除时同步删除子表记录
    ON UPDATE SET NULL; -- 主表更新时子表字段设为NULL
    ```
    
4. ​**约束名称**​：建议显式命名外键（如 `fk_user`），便于后续管理（修改或删除约束）。
    

通过这两种方法，可以灵活地维护表间关系，确保数据库的引用完整性。实际应用中，根据表结构的设计阶段选择合适的方式。


#### 删除外键关联


##### 语法格式

```
ALTER TABLE 表名 DROP FOREIGN KEY 外键名称;
```

##### 具体示例

假设需要删除 `orders`表中的外键约束 `fk_user`：

```
ALTER TABLE orders DROP FOREIGN KEY fk_user;
```

##### 完整操作流程

1. ​**查看外键名称**​
    

```
SHOW CREATE TABLE orders;
```

1. ​**执行删除操作**​
    

```
ALTER TABLE orders DROP FOREIGN KEY fk_user;
```

##### 注意事项

- 删除外键不会删除表中的数据，只会移除表间的
  关联约束
    
- 执行前需确认外键名称准确无误
    
- 建议在删除前备份重要数据