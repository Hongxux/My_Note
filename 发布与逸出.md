**主要了解一个对象是怎么样逸出的**

嗨，欢迎继续阅读！这一节我们进入并发编程中一个非常关键的概念——"发布与逸出"，这是构建线程安全程序的基础。从前面章节（如3.1节的可见性问题）我们了解了数据同步的重要性，而这一节将深入探讨如何正确地"共享"对象，为后面章节（如3.5节的安全发布）打下坚实基础。

作者在这里的目的是揭示一个常见但危险的陷阱：不恰**当的对象发布会破坏封装性，导致线程安全问题。** 这本质上是对面向对象封装原则的"补充"——在单线程中封装能保证数据安全，但在多线程环境下需要额外的同步机制。

作者的组织逻辑是：先定义概念，然后通过多个反面示例展示逸出的危害，最后给出解决方案。

特别需要注意的是，"发布"与"逸出"是易混淆的概念：
- 发布是**有意**的对象共享，
- 逸出是**无意**的、危险的对象泄露。

新名词解释：

- ​**发布（Publish）​**​：有意使对象在当前作用域外可用，如将引用保存到公共位置或从非私有方法返回。
    
- ​**逸出（Escape）​**​：​**不该发布的对象被意外发布**，破坏封装性和线程安全。
    
- ​**外部方法（Alien Method）​**​：行为不由当前类完全控制的方法，包括其他类的方法和可重写方法。
    

现在，让我们按照作者的文章逻辑来生成问题。文章先定义发布与逸出，然后通过示例展示各种逸出场景，最后给出安全构造的解决方案。

​**先说明发布与逸出的基本概念和区别；**​

1. 什么是对象发布？发布对象的三种常见方式是什么？
    **对象发布**是使对象在當前作用域外可用。
    
	总结**对象发布的核心本质就是：将原本局限于某个作用域（如方法内部、类内部）的对象，通过特定方式暴露给更广的作用域（如其他类、其他线程），使其可被共享访问**。
	- 常见的**特定方式**三种方式：
	    - 保存引用到公共静态变量（共享）
	    - 非私有方法返回引用（传递）
	    - 传递引用到其他类方法（传递）
1. 逸出与发布的关键区别是什么？为什么逸出是危险的？
    **逸出**是不该发布的对象被意外发布，而发布是有意的。逸出危险在于破坏封装性，使不变性条件难以维持。

​**然后通过具体示例分析不同类型的逸出问题；**​

1. 程序清单3-5和3-6展示了哪种逸出？UnsafeStates中的states数组逸出会带来什么具体风险？
    UnsafeStates中states数组逸出后，任何调用者都能修改数组内容，破坏封装。而且这个对象的非私有域中引用的所有对象也会逸出。（连锁反应）
2. 什么是"外部方法"？将对象传递给外部方法为什么可能导致逸出？
     ​**外部方法**是行为不完全由当前类控制的方法。传递对象给外部方法时，无法知道该方法会如何处置对象，可能保留引用并在其他线程使用。
3. 程序清单3-7的ThisEscape示例中，this引用是如何在构造过程中逸出的？这会带来什么严重后果？
     ThisEscape在构造函数中创建内部类EventListener并注册，内部类隐含持有外部类this引用，导致对象**未完全构造完成**就被发布，其他线程可能看到不一致状态。
	 -  **根本原因**​：Java对象的构造过程**不是原子操作**。构造函数中的代码可能分多步执行（如字段初始化、嵌套对象创建等），而其他线程可能在任意中间步骤访问该对象。
	- ​**危险场景**​：当对象的`this`引用在构造函数结束前被发布（如传递给其他线程、注册回调等），其他线程看到的对象可能缺失关键初始化。

​**最后讨论安全的对象构造模式；**​

1. 程序清单3-8的SafeListener如何通过工厂方法避免this引用逸出？这种模式的关键要点是什么？
    SafeListener使用**私有构造函数+公共工厂方法**​：先完全构造对象，再发布监听器。**关键是将构造与发布分离，确保对象处于一致状态后再发布。**
    

### 面试官可能关心的方面及答案

面试官常从这一节考察你对对象生命周期和线程安全的理解：

- ​**问题**​：在构造函数中启动线程为什么危险？
    
    ​**答案**​：因为this引用会逸出到新线程，而对象可能尚未完全构造完成，新线程可能看到不一致的状态。
    
- ​**问题**​：如何安全地发布对象？
    
    ​**答案**​：1）确保对象完全构造后再发布；2）使用工厂方法控制发布时机；3）对需要同步的发布使用适当的同步机制。
    
- ​**问题**​：逸出会破坏哪些设计原则？
    
    ​**答案**​：主要破坏封装性，进而破坏[[不变性条件]]的维持能力，使程序正确性分析变得困难。
    

这一节是并发编程的基石概念，理解发布与逸出能帮助你在后续学习中更好地把握线程安全的设计原则。继续加油，你的并发知识体系正在不断完善！