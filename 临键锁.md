#### 临键锁 - “间隙锁 + 行锁”的合体

- ​**定义**​：临键锁 = ​**间隙锁**​ + ​**记录锁**。它锁住一条记录，​以及该记录**之前**的间隙，它会锁定一个**左开右闭**的区间，例如 `(5, 10]`。。
- 间隙锁有生效的前提
	- 隔离级别：RR
	- 索引
- ​**作用**​：它是 InnoDB 在 ​**可重复读隔离级别**​ 下**默认的加锁单位**。通过锁定“一个区间”，它既能防止别的事务修改当前记录（行锁的作用），也能防止在区间内插入新记录（间隙锁的作用），从而**解决大部分幻读**。
	- 能解决的幻读：
		- 场景：同一事务内多次 “当前读”（`SELECT ... FOR UPDATE`、`UPDATE`、`DELETE`）；
		- 原理：临键锁锁定查询区间，阻止其他事务插入 / 删除符合条件的记录，确保行数不变。
	- 无法解决的幻读
		- 核心场景：同一事务内 “快照读 + 当前读” 混用（最常见）；
		- 其他场景：非索引列查询的快照读阶段插入记录（本质仍是快照读不加锁）；
		- 根因：临键锁仅作用于当前读，快照读基于 MVCC 不加锁，允许其他事务插入记录，导致两次查询行数变化。
	- 完全解决幻读的方案
		- 方案 1：使用 `SERIALIZABLE` 隔离级别（强制所有查询为当前读，加锁串行执行）；
		- 方案 2：事务内所有查询统一使用 “当前读”（如 `SELECT ... FOR UPDATE`），避免快照读与当前读混用。
    
- ​**示例**​：对记录 `10`加临键锁，锁定的范围是 `(5, 10]`（即：从5的下一个值开始，到10为止，包含10本身）。



