HTTP+ 加密 + 认证 + 完整性保护 =HTTPS

![[Pasted image 20250914214112.png]]
# HTTPS 采用混合加密机制
好的，这是一个非常重要的密码学概念，也是理解HTTPS、SSH等安全协议的基础。我将结合《图解HTTP》中的核心思想，用易于理解的方式为您解释。

### ​**核心概念一句话总结**​

- ​**共享密钥加密（对称加密）​**​：加密和解密使用**同一把钥匙**。就像你用同一把钥匙锁门和开门。
    
- ​**公开密钥加密（非对称加密）​**​：加密和解密使用**一对钥匙**​（公钥和私钥）。公钥是公开的锁头，私钥是唯一能打开的钥匙。
    

---

为了让您更直观地理解两者的核心区别与流程，下图展示了它们的工作模型：

### ​**核心流程对比图**​

```
flowchart TD
subgraph A[共享密钥加密（对称加密）]
    A1(同一把密钥K) --> A2
    A1 --> A3
    A2[发送方<br>用密钥K加密明文] --> A4[密文<br>通过网络传输] --> A3[接收方<br>用密钥K解密密文]
end

subgraph B[公开密钥加密（非对称加密）]
    B1(接收方生成密钥对) --> B1_1[公钥<br>可以发给任何人]
    B1 --> B1_2[私钥<br>严格保密]
    
    B2[发送方<br>用公钥加密明文] --> B4[密文<br>通过网络传输] --> B3[接收方<br>用私钥解密密文]
    
    B1_1 --> B2
end
```

上图清晰地展示了两种加密方式的根本差异：​**密钥的数量和使用方式**。下面我们将深入探讨它们的细节、优缺点和实际应用。

---

### ​**一、共享密钥加密 (Symmetric-Key Encryption)​**​

也称为 ​**对称加密**。

#### ​**1. 工作原理**​

- 通信双方**共享同一把密钥**​ `K`。
    
- 发送方使用密钥 `K`加密明文。
    
- 接收方使用**同一个密钥 `K`**​ 解密密文。
    

#### ​**2. 优缺点**​

|​**优点**​|​**缺点**​|
|---|---|
|​**速度快**，算法效率高，适合加密大量数据。|​**密钥分发困难**​：如何安全地将密钥交给对方？|
||​**密钥管理复杂**​：如果和N个不同对象通信，需要维护N把不同的密钥。|

#### ​**3. 常见算法**​

- ​**DES**​ (Data Encryption Standard)
    
- ​**3DES**​ (Triple DES)
    
- ​**AES**​ (Advanced Encryption Standard) - ​**目前最常用**​
    

#### ​**4. 程序员需要考虑的问题**​

- ​**绝对不能在网络中明文传输密钥**，否则加密失去意义。
    
- 密钥需要定期更换，以增加安全性。
    
- 在分布式系统中，如何安全地存储和分发密钥是一个巨大挑战（常使用**Vault**、**KMS**等密钥管理服务）。
    

---

### ​**二、公开密钥加密 (Public-Key Encryption)​**​

也称为 ​**非对称加密**。

#### ​**1. 工作原理**​

- 通信一方（通常是服务器）生成一对**​ mathematically相关**的密钥：​**公钥 (Public Key)​**​ 和 ​**私钥 (Private Key)​**。
    
- ​**公钥**可以公开给任何人。它用于**加密**数据。
    
- ​**私钥**必须严格保密，绝对不泄露。它用于**解密**数据。
    
- ​**核心特性**​：用公钥加密的内容，​**只有对应的私钥才能解密**。反之亦然（可用于数字签名）。
    

#### ​**2. 优缺点**​

|​**优点**​|​**缺点**​|
|---|---|
|​**解决了密钥分发问题**​：公钥可以公开，无需保密。|​**速度非常慢**，比对称加密慢上百倍，不适合加密大量数据。|

#### ​**3. 常见算法**​

- ​**RSA**​ - 最经典和常用的算法
    
- ​**ECC**​ (Elliptic Curve Cryptography) - 在相同安全强度下，密钥更短，效率更高。
    
- ​**DH**​ (Diffie-Hellman) - 用于密钥交换。
    

---

### ​**三、混合加密机制：HTTPS的实际应用**​

由于两种加密方式各有优缺点，现代安全协议（如HTTPS、SSL/TLS）采用了**混合加密机制**，取长补短，这也是程序员最需要理解的实践。

​**目标**​：既拥有公开密钥加密的安全性，又拥有共享密钥加密的速度。

​**流程如下（简化版）​**​：

1. ​**使用公开密钥加密交换“会话密钥”​**​
    
    - 客户端获取服务器的公钥（通常包含在数字证书中）。
        
    - 客户端生成一个随机的**会话密钥**​（这是一个对称密钥）。
        
    - 客户端**用服务器的公钥**加密这个**会话密钥**，然后发送给服务器。
        
    
2. ​**使用共享密钥加密通信**​
    
    - 服务器用自己的私钥解密，得到**会话密钥**。
        
    - 此后，双方通信都使用这个**会话密钥**进行快速的对称加密和解密。
        
    

​**这样做的原因**​：

- ​**安全**​：会话密钥是临时生成的，且用公钥加密传输，解决了密钥分发问题。
    
- ​**高效**​：后续通信使用对称加密，速度极快，适合大量数据传输。
    

这个过程完美体现了两种加密方式的协同工作，其流程如下图所示：

```
sequenceDiagram
    participant C as 客户端
    participant S as 服务器

    Note over C, S: 协商阶段（使用非对称加密）
    C->>S: 请求公钥
    S->>C: 返回公钥证书
    Note left of C: 生成随机会话密钥K
    C->>S: 用公钥加密会话密钥K并发送

    Note over C, S: 通信阶段（使用对称加密）
    Note left of C: 使用密钥K加密数据
    C->>S: 发送加密后的数据
    Note right of S: 使用密钥K解密数据
    S->>C: 用密钥K加密响应数据并返回
```

#### ​**总结与类比**​

||​**共享密钥加密（对称）​**​|​**公开密钥加密（非对称）​**​|
|---|---|---|
|​**密钥**​|一把钥匙|两把钥匙（公钥和私钥）|
|​**速度**​|快|慢|
|​**用途**​|​**加密大量数据**​|​**安全地分发对称密钥**、**数字签名**​|
|​**经典比喻**​|​**同一把钥匙锁门和开门**​|​**公钥是任何人都能合上的挂锁，私钥是只有自己有的开锁钥匙**​|

对于程序员来说，理解这一点至关重要：

- 当你配置HTTPS证书时，你其实是在配置服务器的**公钥和私钥**。
    
- SSL/TLS握手过程，本质上就是在完成上述**混合加密**中的“会话密钥”交换。
    
- SSH免密登录也是利用了非对称加密，你将你的**公钥**放到服务器上，服务器用它来加密一个挑战，只有拥有对应**私钥**的你才能解密并完成认证。

### 四、证明公开密匙的证书
#### 1. ​**解决公钥信任问题**​

- •
    
    ​**背景挑战**​：
    
    非对称加密中，客户端需获取服务器公钥，但网络传输可能被中间人攻击（如攻击者替换伪造公钥）。
    
- •
    
    ​**证书作用**​：
    
    由可信第三方（**CA，证书颁发机构**）对服务器公钥进行数字签名，形成**[[公钥证书]]**，验证公钥归属的真实性。
    
    ![[Pasted image 20250915090134.png]]
    

#### 2. ​**实现身份认证**​

- •
    
    ​**包含信息**​：
    
    证书内绑定服务器域名、公钥、颁发机构、有效期等（如 `CN=www.example.com`）。
    
- •
    
    ​**浏览器行为**​：
    
    校验证书域名与访问域名是否匹配，防止钓鱼网站。
#### 3. 可证明组织真实性的 EV SSL 证书
- **意图** ：为了防止用户被钓鱼攻击
- **作用**：可确认对方服务器背后运营的企业是否真实存在。EV SSL 证书是基于国际标准的认证指导方针颁发的证书。其严 格规定了对运营组织是否真实的确认方针，因此，通过认证的 Web 网站能够获得更高的认可度。
#### 4. [[用以确认客户端的客户端证书]]
- **意图**：证明服务器正在通信的对方始终是预料之内的客户端
- **问题**：
	- 需要客户端自行**购买**，
	- 自行**安装**。要让知识层次不同的用户们自行安 装证书，这件事本身也充满了各种挑战。
	- 客户端证书毕竟只能用来证明客户端实际存在，而不能用来证明用户本人的真实有效性。也就是说，只要获得了安装有客户端证书的计算机的使用权限，也就意味着同时拥有了客户端证书的使用权限。
- **目前用途**：安全性极高的认证机构可颁发客户端证书但仅用于特殊 用途的业务。比如那些可支撑客户端证书支出费用的业务。==例如，银行的网上银行就采用了客户端证书。在登录网银时不仅 要求用户确认输入 ID 和密码，还会要求用户的客户端证书，以 确认用户是否从特定的终端访问网银。==


# HTTPS的安全通信机制
---

### 一、**SSL/TLS握手建立安全通道**​

#### 1. ​**协商加密参数**​

- 客户端发送`ClientHello`：
    
    声明支持的TLS版本、加密套件（如`TLS_AES_256_GCM_SHA384`）及随机数`ClientRandom`。
    
- 服务器回应`ServerHello`：
    
    选定加密套件 + 生成随机数`ServerRandom`。
    

#### 2. ​**服务器身份验证**​

- 服务器发送**公钥证书**​（含域名、公钥、CA签名）：
    
    客户端验证证书有效性（CA信任链+域名匹配）。
    

---

### 二、**共享密钥生成与交换**​

#### 1. ​**预备主密钥（Premaster Secret）传递**​

- ​**客户端操作**​：
    
    1. 生成随机数`PremasterSecret`（46字节）。
        
    2. 用**服务器证书公钥**加密`PremasterSecret`→ 发送`ClientKeyExchange`报文。
        
    
- ​**服务器操作**​：
    
    用**服务器私钥解密**​ → 获取`PremasterSecret`。
    

> 🔒 ​**安全核心**​：
> 
> 非对称加密保障`PremasterSecret`仅服务器能解密，即使被截获也无法破解。

#### 2. ​**主密钥（Master Secret）生成**​

- ​**双方独立计算**​：
    
    使用`ClientRandom`+ `ServerRandom`+ `PremasterSecret`，通过**[[伪随机函数（PRF）]]​**​ 生成48字节`MasterSecret`。
    
    MasterSecret=PRF(ClientRandom,ServerRandom,PremasterSecret)
	[[ClientRandom与ServerRandom在SSL、TLS握手中的必要性|为什么要用ClientRandom和ServerRandom]]

---

### 三、 ​**切换至共享密钥通信**​

#### 1. ​**会话密钥（Session Key）派发**​

- ​**双方独立派生密钥块**​：
    
    基于`MasterSecret`生成**6个对称密钥**​：
    
    客户端加密密钥,服务器加密密钥,客户端MAC密钥,服务器MAC密钥,客户端IV,服务器IV=PRF(MasterSecret,"keyexpansion",ClientRandom+ServerRandom)
    
    > 📌 ​**注**​：AES-GCM等现代算法无需独立MAC密钥。
    

#### 2. ​**就绪通知与加密切换**​

- 客户端发送`ChangeCipherSpec`：
    
    声明后续报文将使用**会话密钥加密**。
    
- 客户端发送`Finished`：
    
    加密验证握手完整性（包含所有握手报文哈希值）。
    
- 服务器同理发送`ChangeCipherSpec`+ `Finished`确认。
    

---

### 四、**共享密钥通信阶段**​

#### 1. ​**对称加密高效传输**​

- 后续所有HTTP数据均通过**会话密钥加密传输**​（如AES-256-GCM）：
    
    - 客户端加密：`AES(SessionKey, PlainText)`
        
    - 服务器解密：`AES^{-1}(SessionKey, CipherText)`
        
    

#### 2. ​**性能与安全平衡**​

|​**阶段**​|加密方式|性能消耗|安全目标|
|---|---|---|---|
|握手阶段|非对称加密|高|安全交换`PremasterSecret`|
|数据传输阶段|对称加密|低|高效加密大量应用数据|

---

### 五、**关键流程全图**​

```
sequenceDiagram
    participant C as Client
    participant S as Server

    Note over C,S: 1. 协商与认证
    C->>S: ClientHello (TLS版本/加密套件/ClientRandom)
    S->>C: ServerHello (选定套件/ServerRandom) + 证书链
    alt 双向认证
        C->>S: 客户端证书（可选）
    end

    Note over C,S: 2. 密钥交换
    C->>S: ClientKeyExchange (加密的PremasterSecret)
    Note left of C: 生成MasterSecret
    Note right of S: 生成MasterSecret

    Note over C,S: 3. 切换共享密钥
    C->>S: ChangeCipherSpec + Finished (加密校验)
    S->>C: ChangeCipherSpec + Finished (加密校验)

    Note over C,S: 4. 加密通信
    loop 应用数据传输
        C->>S: 对称加密的HTTP请求
        S->>C: 对称加密的HTTP响应
    end
```

---

### 六、**程序员实践要点**​

1. ​**密钥交换算法选择**​
    
    - 优先使用**前向安全算法**​（如ECDHE）：即使服务器私钥泄露，历史会话仍安全。
        
    - 禁用不安全算法：
        
        ```
        ssl_ciphers 'ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384';
        ```
        
    
2. ​**会话复用优化性能**​
    
    - 启用`Session Resumption`：
        
        ```
        ssl_session_cache shared:SSL:10m;
        ssl_session_timeout 10m;
        ```
        
        避免重复握手（减少RTT延迟）。
        
    
3. ​**密钥生命周期管理**​
    
    - 会话密钥默认有效期：TLS 1.2约24小时（超时强制重新握手）。
        
    - 敏感服务可主动缩短时效：
        
        ```
        ssl_session_timeout 1h;  # 1小时强制刷新密钥
        ```
        
    

> 💎 ​**核心总结**​：
> 
> HTTPS通过**非对称加密交换种子密钥**​ → ​**独立生成主密钥**​ → ​**派发高效会话密钥**的三层机制，既解决密钥分发安全难题，又实现高性能加密通信。此设计是Web安全的基石。