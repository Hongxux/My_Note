åœ¨ Redis é›†ç¾¤ç¯å¢ƒä¸­ï¼Œ**æ•°æ®å€¾æ–œ**æ˜¯ä¸€ä¸ªå¸¸è§ä½†ä¸¥é‡çš„é—®é¢˜ï¼Œå®ƒä¼šå¯¼è‡´éƒ¨åˆ†èŠ‚ç‚¹è´Ÿè½½è¿‡é«˜ï¼Œå½±å“é›†ç¾¤æ€§èƒ½å’Œç¨³å®šæ€§ã€‚ä¸‹é¢æˆ‘è¯¦ç»†åˆ†ææ•°æ®å€¾æ–œçš„å„ç§åœºæ™¯ã€åŸå› å’Œè§£å†³æ–¹æ¡ˆã€‚

## ğŸ” æ•°æ®å€¾æ–œçš„æ ¸å¿ƒè¡¨ç°

|å€¾æ–œç±»å‹|è¡¨ç°ç‰¹å¾|å½±å“ç¨‹åº¦|
|---|---|---|
|**å­˜å‚¨å€¾æ–œ**â€‹|æŸäº›èŠ‚ç‚¹å†…å­˜ä½¿ç”¨ç‡è¿œé«˜äºå…¶ä»–èŠ‚ç‚¹|â­â­â­â­â­ (ä¸¥é‡)|
|**æµé‡å€¾æ–œ**â€‹|æŸäº›èŠ‚ç‚¹QPS/å¸¦å®½ä½¿ç”¨ç‡å¼‚å¸¸é«˜|â­â­â­â­ (é«˜)|
|**CPUå€¾æ–œ**â€‹|æŸäº›èŠ‚ç‚¹CPUä½¿ç”¨ç‡æŒç»­é«˜ä½|â­â­â­ (ä¸­)|

## ğŸ¯ æ•°æ®å€¾æ–œçš„å…«å¤§åœºæ™¯åŠè§£å†³æ–¹æ¡ˆ

### 1. **Hash Tag ä½¿ç”¨ä¸å½“å¯¼è‡´çš„çƒ­ç‚¹Key**

**åœºæ™¯**ï¼šè¿‡åº¦ä½¿ç”¨ç›¸åŒçš„Hash Tagå¯¼è‡´å¤§é‡æ•°æ®é›†ä¸­åœ¨å•ä¸ªèŠ‚ç‚¹

```
# é”™è¯¯ç¤ºä¾‹ï¼šæ‰€æœ‰ç”¨æˆ·æ•°æ®éƒ½ä½¿ç”¨ç›¸åŒçš„ {user} tag
SET {user}:1001:profile "data..."
SET {user}:1002:profile "data..." 
SET {user}:1003:profile "data..."
# ç»“æœï¼šæ‰€æœ‰æ•°æ®éƒ½é›†ä¸­åœ¨åŒä¸€ä¸ªslotå’ŒèŠ‚ç‚¹
```

**è§£å†³æ–¹æ¡ˆ**ï¼š

```
# æ­£ç¡®åšæ³•ï¼šä½¿ç”¨æ›´ç»†ç²’åº¦çš„Hash Tag
SET user:{1001}:profile "data..."    # åˆ†æ•£åˆ°ä¸åŒslot
SET user:{1002}:profile "data..."
SET order:{2001}:info "data..."     # ä¸åŒä¸šåŠ¡ä½¿ç”¨ä¸åŒtag
```

### 2. **å¤§Keyï¼ˆBigKeyï¼‰å¯¼è‡´çš„å­˜å‚¨å€¾æ–œ**

**åœºæ™¯**ï¼šå•ä¸ªKeyå­˜å‚¨è¿‡å¤§æ•°æ®ï¼Œå ç”¨å•ä¸ªèŠ‚ç‚¹å¤§é‡å†…å­˜

```
# å±é™©çš„å¤§Keyç¤ºä¾‹
HSET product:stats "2024-01-01" "1MB_data" "2024-01-02" "1MB_data" ... # åŒ…å«10ä¸‡å­—æ®µ
ZADD leaderboard 1 "user1" 2 "user2" ... # åŒ…å«ç™¾ä¸‡æˆå‘˜
```

**æ£€æµ‹å‘½ä»¤**ï¼š

```
# æ‰«æå¤§Key
redis-cli --bigkeys

# åˆ†æå†…å­˜åˆ†å¸ƒ
redis-cli memory stats
```

**è§£å†³æ–¹æ¡ˆ**ï¼š

```
// å¤§Hashæ‹†åˆ†ç¤ºä¾‹
public class BigKeySplitter {
    // å°†å¤§HashæŒ‰å­—æ®µèŒƒå›´åˆ†ç‰‡
    public void splitBigHash(String bigKey, int shardSize) {
        Map<String, String> originalData = redisTemplate.opsForHash().entries(bigKey);
        
        int shardIndex = 0;
        Map<String, String> currentShard = new HashMap<>();
        
        for (Map.Entry<String, String> entry : originalData.entrySet()) {
            currentShard.put(entry.getKey(), entry.getValue());
            
            if (currentShard.size() >= shardSize) {
                String shardKey = bigKey + ":shard:" + shardIndex++;
                redisTemplate.opsForHash().putAll(shardKey, currentShard);
                currentShard.clear();
            }
        }
        
        // å¤„ç†å‰©ä½™æ•°æ®
        if (!currentShard.isEmpty()) {
            String shardKey = bigKey + ":shard:" + shardIndex;
            redisTemplate.opsForHash().putAll(shardKey, currentShard);
        }
        
        // åˆ é™¤åŸå¤§Key
        redisTemplate.delete(bigKey);
    }
}
```

### 3. **çƒ­ç‚¹Keyè®¿é—®å¯¼è‡´çš„æµé‡å€¾æ–œ**

**åœºæ™¯**ï¼šå°‘æ•°Keyè¢«æé«˜é¢‘ç‡è®¿é—®ï¼Œé€ æˆå•ä¸ªèŠ‚ç‚¹ç½‘ç»œå’ŒCPUç“¶é¢ˆ

```
// çƒ­ç‚¹Keyç¤ºä¾‹ï¼šç§’æ€å•†å“ã€çƒ­é—¨æ–°é—»ã€é…ç½®é¡¹ç­‰
@RestController
public class ProductController {
    @GetMapping("/product/{id}")
    public Product getProduct(@PathVariable String id) {
        // æ‰€æœ‰è¯·æ±‚éƒ½é›†ä¸­åœ¨åŒä¸€ä¸ªKey
        return redisTemplate.opsForValue().get("product:" + id);
    }
}
```

**è§£å†³æ–¹æ¡ˆ**ï¼šå¤šçº§ç¼“å­˜ + Keyåˆ†ç‰‡

```
@Service
public class HotKeySolution {
    
    // 1. æœ¬åœ°ç¼“å­˜ç¼“è§£Rediså‹åŠ›
    @Cacheable(value = "productCache", key = "#id", unless = "#result == null")
    public Product getProductWithLocalCache(String id) {
        return getFromRedis(id);
    }
    
    // 2. Keyåˆ†ç‰‡ï¼šå°†çƒ­ç‚¹Keyåˆ†æ•£åˆ°å¤šä¸ªèŠ‚ç‚¹
    public Product getProductSharded(String productId) {
        int shard = Math.abs(productId.hashCode()) % 10; // åˆ†10ç‰‡
        String shardedKey = "product:" + productId + ":" + shard;
        
        return redisTemplate.opsForValue().get(shardedKey);
    }
    
    // 3. éšæœºè¿‡æœŸæ—¶é—´é¿å…ç¼“å­˜åŒæ—¶å¤±æ•ˆ
    public void setProductWithRandomExpire(String id, Product product) {
        int randomExpire = 3600 + new Random().nextInt(300); // 3600-3900ç§’
        redisTemplate.opsForValue().set(
            "product:" + id, product, randomExpire, TimeUnit.SECONDS
        );
    }
}
```

### 4. **æ•°æ®åˆ†å¸ƒä¸å‡åŒ€å¯¼è‡´çš„å­˜å‚¨å€¾æ–œ**

**åœºæ™¯**ï¼šKeyçš„å“ˆå¸Œå€¼åˆ†å¸ƒä¸å‡åŒ€ï¼Œå¯¼è‡´æŸäº›Slotæ•°æ®è¿‡å¤š

**æ£€æµ‹å‘½ä»¤**ï¼š

```
# æ£€æŸ¥æ¯ä¸ªèŠ‚ç‚¹çš„Keyæ•°é‡åˆ†å¸ƒ
redis-cli --cluster check 192.168.1.100:6379

# æŸ¥çœ‹Slotåˆ†å¸ƒ
redis-cli cluster slots
```

**è§£å†³æ–¹æ¡ˆ**ï¼šå¼ºåˆ¶æ•°æ®é‡æ–°åˆ†å¸ƒ

```
# é‡æ–°åˆ†ç‰‡ï¼ˆéœ€è¦ç®¡ç†å‘˜æƒé™ï¼‰
redis-cli --cluster reshard 192.168.1.100:6379

# è¿ç§»ç‰¹å®šSlotåˆ°å…¶ä»–èŠ‚ç‚¹
redis-cli --cluster reshard --from <æºèŠ‚ç‚¹ID> --to <ç›®æ ‡èŠ‚ç‚¹ID> --slots <æ•°é‡> --yes 192.168.1.100:6379
```

### 5. **ä¸šåŠ¡æ•°æ®ç‰¹å¾å¯¼è‡´çš„è‡ªç„¶å€¾æ–œ**

**åœºæ™¯**ï¼šä¸šåŠ¡æœ¬èº«çš„æ•°æ®ç‰¹å¾å¯¼è‡´åˆ†å¸ƒä¸å‡

- æ—¶é—´åºåˆ—æ•°æ®é›†ä¸­åœ¨æœ€è¿‘æ—¶é—´æ®µ
    
- ç”¨æˆ·æ´»è·ƒåº¦å·®å¼‚å¤§ï¼ˆ1%ç”¨æˆ·äº§ç”Ÿ90%æ•°æ®ï¼‰
    

**è§£å†³æ–¹æ¡ˆ**ï¼šé¢„åˆ†ç‰‡ + TTLç­–ç•¥

```
@Service
public class TimeSeriesSolution {
    
    // æŒ‰æ—¶é—´åˆ†ç‰‡ï¼šæ¯å¤©æ•°æ®å­˜åˆ°ä¸åŒKey
    public String getTimeSeriesKey(String metric, LocalDate date) {
        String dateStr = date.format(DateTimeFormatter.BASIC_ISO_DATE);
        return "metrics:" + metric + ":" + dateStr; // ç¤ºä¾‹: metrics:page_views:20241201
    }
    
    // è‡ªåŠ¨æ¸…ç†è¿‡æœŸæ•°æ®
    @Scheduled(cron = "0 2 * * *") // æ¯å¤©2ç‚¹æ‰§è¡Œ
    public void cleanupOldData() {
        LocalDate weekAgo = LocalDate.now().minusDays(7);
        // åˆ é™¤7å¤©å‰çš„æ•°æ®
        for (String metric : metrics) {
            String oldKey = getTimeSeriesKey(metric, weekAgo);
            redisTemplate.delete(oldKey);
        }
    }
}
```

### 6. **é›†ç¾¤æ‰©å®¹åçš„æ•°æ®å€¾æ–œ**

**åœºæ™¯**ï¼šé›†ç¾¤æ‰©å®¹åï¼Œæ–°èŠ‚ç‚¹æ•°æ®è¾ƒå°‘ï¼Œè€èŠ‚ç‚¹æ•°æ®è¿‡å¤š

**è§£å†³æ–¹æ¡ˆ**ï¼šè‡ªåŠ¨é‡å¹³è¡¡

```
# 1. æ£€æŸ¥å½“å‰æ•°æ®åˆ†å¸ƒ
redis-cli --cluster check 192.168.1.100:6379

# 2. è‡ªåŠ¨é‡æ–°å¹³è¡¡ï¼ˆRedis 7.0+ï¼‰
redis-cli --cluster rebalance --use-empty-masters 192.168.1.100:6379

# 3. æ‰‹åŠ¨è¿ç§»çƒ­ç‚¹Slot
redis-cli --cluster reshard --from <çƒ­ç‚¹èŠ‚ç‚¹> --to <æ–°èŠ‚ç‚¹> --slots 1000 192.168.1.100:6379
```

### 7. **è¯»å†™åˆ†ç¦»é…ç½®ä¸å½“å¯¼è‡´çš„å€¾æ–œ**

**åœºæ™¯**ï¼šæ‰€æœ‰å†™æ“ä½œéƒ½é›†ä¸­åœ¨ä¸»èŠ‚ç‚¹ï¼Œè¯»æ“ä½œé›†ä¸­åœ¨æŸä¸ªä»èŠ‚ç‚¹

**è§£å†³æ–¹æ¡ˆ**ï¼šåˆç†çš„è¯»å†™åˆ†ç¦»ç­–ç•¥

```
@Configuration
public class ReadWriteConfig {
    
    @Bean
    public RedisTemplate<String, Object> redisTemplate() {
        RedisTemplate<String, Object> template = new RedisTemplate<>();
        
        // é…ç½®è¯»å†™åˆ†ç¦»
        template.setEnableTransactionSupport(true);
        
        // å†™æ“ä½œä½¿ç”¨ä¸»èŠ‚ç‚¹ï¼ˆé»˜è®¤ï¼‰
        // è¯»æ“ä½œå¯ä»¥æŒ‡å®šä½¿ç”¨ä»èŠ‚ç‚¹ï¼ˆéœ€è¦è‡ªå®šä¹‰RedisTemplateï¼‰
        
        return template;
    }
    
    // è‡ªå®šä¹‰è¯»æ“ä½œè·¯ç”±åˆ°ä»èŠ‚ç‚¹
    @Bean
    public StringRedisTemplate readOnlyRedisTemplate() {
        LettuceConnectionFactory readOnlyFactory = new LettuceConnectionFactory();
        readOnlyFactory.setReadOnly(true); // è®¾ç½®ä¸ºåªè¯»ï¼Œä¼˜å…ˆä½¿ç”¨ä»èŠ‚ç‚¹
        StringRedisTemplate template = new StringRedisTemplate(readOnlyFactory);
        template.afterPropertiesSet();
        return template;
    }
}
```

### 8. **å®¢æˆ·ç«¯è·¯ç”±ç®—æ³•é—®é¢˜**

**åœºæ™¯**ï¼šå®¢æˆ·ç«¯å®ç°çš„è·¯ç”±ç®—æ³•æœ‰ç¼ºé™·ï¼Œå¯¼è‡´è¯·æ±‚åˆ†å¸ƒä¸å‡

**è§£å†³æ–¹æ¡ˆ**ï¼šä½¿ç”¨æˆç†Ÿçš„å®¢æˆ·ç«¯åº“ + ç›‘æ§

```
@Component
public class ClientSideBalancing {
    
    // ä½¿ç”¨ä¸€è‡´æ€§å“ˆå¸Œç­‰ç®—æ³•ç¡®ä¿å‡åŒ€åˆ†å¸ƒ
    public String getTargetNode(String key, Set<String> clusterNodes) {
        // ä½¿ç”¨ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•é€‰æ‹©èŠ‚ç‚¹
        return consistentHash.selectNode(key, clusterNodes);
    }
    
    // ç›‘æ§å®¢æˆ·ç«¯è·¯ç”±åˆ†å¸ƒ
    @Scheduled(fixedRate = 60000)
    public void monitorRequestDistribution() {
        Map<String, Integer> requestCount = getRequestDistribution();
        
        // è®¡ç®—æ ‡å‡†å·®ï¼Œæ£€æµ‹æ˜¯å¦å€¾æ–œ
        double stdDev = calculateStdDev(requestCount.values());
        if (stdDev > THRESHOLD) {
            alertService.sendAlert("è¯·æ±‚åˆ†å¸ƒå€¾æ–œæ£€æµ‹: " + stdDev);
        }
    }
}
```

## ğŸ”§ æ•°æ®å€¾æ–œæ£€æµ‹å·¥å…·é›†

### 1. **å®æ—¶ç›‘æ§è„šæœ¬**

```
#!/bin/bash
# monitor_skew.sh

CLUSTER_NODE="192.168.1.100:6379"

echo "=== Redisé›†ç¾¤å€¾æ–œæ£€æµ‹ ==="

# 1. æ£€æŸ¥å†…å­˜åˆ†å¸ƒ
echo "å†…å­˜ä½¿ç”¨åˆ†å¸ƒ:"
redis-cli --cluster check $CLUSTER_NODE | grep -E "(used_memory_human|percent)"

# 2. æ£€æŸ¥Keyæ•°é‡åˆ†å¸ƒ
echo "Keyæ•°é‡åˆ†å¸ƒ:"
redis-cli --cluster check $CLUSTER_NODE | grep -E "keys:"

# 3. æ£€æŸ¥QPSåˆ†å¸ƒ
for port in 6379 6380 6381; do
    qps=$(redis-cli -h 192.168.1.100 -p $port info stats | grep "instantaneous_ops_per_sec" | cut -d: -f2)
    echo "Node $port QPS: $qps"
done
```

### 2. **è‡ªåŠ¨åŒ–å€¾æ–œå‘Šè­¦**

```
@Component
public class SkewMonitor {
    
    @Scheduled(fixedRate = 300000) // 5åˆ†é’Ÿæ£€æµ‹ä¸€æ¬¡
    public void checkClusterBalance() {
        Map<String, NodeStats> nodeStats = collectNodeStats();
        
        // è®¡ç®—å„é¡¹æŒ‡æ ‡çš„å˜å¼‚ç³»æ•°(Coefficient of Variation)
        double memoryCv = calculateCoefficientOfVariation(
            nodeStats.values().stream().map(NodeStats::getUsedMemory).collect(Collectors.toList())
        );
        
        double keysCv = calculateCoefficientOfVariation(
            nodeStats.values().stream().map(NodeStats::getKeyCount).collect(Collectors.toList())
        );
        
        // è§¦å‘å‘Šè­¦é˜ˆå€¼
        if (memoryCv > 0.3 || keysCv > 0.4) { // 30%å†…å­˜å·®å¼‚æˆ–40%Keyæ•°é‡å·®å¼‚
            alertService.sendSkewAlert(memoryCv, keysCv, nodeStats);
        }
    }
}
```

## ğŸ’¡ é¢„é˜²æ•°æ®å€¾æ–œçš„æœ€ä½³å®è·µ

1. **è®¾è®¡é˜¶æ®µé¢„é˜²**
    
    - é¿å…è¿‡åº¦ä½¿ç”¨Hash Tag
        
    - é¢„ä¼°æ•°æ®é‡å’Œè®¿é—®æ¨¡å¼
        
    - è®¾è®¡åˆç†çš„æ•°æ®åˆ†ç‰‡ç­–ç•¥
        
    
2. **ç›‘æ§é¢„è­¦**
    
    - å®æ—¶ç›‘æ§å„èŠ‚ç‚¹èµ„æºä½¿ç”¨ç‡
        
    - è®¾ç½®å€¾æ–œæ£€æµ‹å‘Šè­¦é˜ˆå€¼
        
    - å®šæœŸæ‰§è¡Œæ•°æ®åˆ†å¸ƒåˆ†æ
        
    
3. **è‡ªåŠ¨åŒ–å¤„ç†**
    
    - å®ç°è‡ªåŠ¨é‡å¹³è¡¡æœºåˆ¶
        
    - å»ºç«‹çƒ­ç‚¹Keyè‡ªåŠ¨è¿ç§»æµç¨‹
        
    - é…ç½®è‡ªåŠ¨æ‰©ç¼©å®¹ç­–ç•¥
        
    

æ•°æ®å€¾æ–œæ˜¯Redisé›†ç¾¤è¿ç»´ä¸­çš„å¸¸è§æŒ‘æˆ˜ï¼Œé€šè¿‡åˆç†çš„æ¶æ„è®¾è®¡ã€æŒç»­çš„ç›‘æ§å’ŒåŠæ—¶çš„è°ƒæ•´ï¼Œå¯ä»¥æœ‰æ•ˆåœ°é¢„é˜²å’Œè§£å†³å€¾æ–œé—®é¢˜ï¼Œç¡®ä¿é›†ç¾¤çš„ç¨³å®šé«˜æ€§èƒ½è¿è¡Œã€‚