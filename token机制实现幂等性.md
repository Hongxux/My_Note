
1. **获取令牌（Get Token）**：在发起需要幂等性保护的业务请求（如提交订单）之前，客户端先调用服务端提供的专用接口获取一个全局唯一的Token。这个Token通常是由服务端生成的UUID或分布式ID。
2. **存储与返回（Store & Return）**：服务端生成Token后，会将其作为Key（通常带有前缀，如 `idempotent:token:...`）存储到Redis等高性能缓存中，并设置一个合理的过期时间（如30分钟），然后将Token返回给客户端。
3. **携带令牌提交请求（Submit Request with Token）**：客户端在后续真正的业务请求中（例如，创建订单的POST请求），必须携带此Token。通常的做法是将其放在HTTP请求头中，例如 `Idempotent-Token: your_token_here`。
4. **验证并消费令牌（Verify & Consume Token）**：这是最核心的一步。服务端在收到业务请求后，会执行一个**原子性操作**：
    - 根据请求头中的Token，检查其在Redis中是否存在。
    - 如果存在，则立即将其删除（消费）；如果不存在，则说明这个Token已经被使用过或已过期。
    - 这个“检查存在并删除”的动作必须是原子的，通常借助Redis Lua脚本实现，以防止在高并发场景下出现多个请求同时验证成功的问题。
5. **处理业务逻辑（Process Business Logic）**：
    - 如果Token验证成功（存在且被成功删除），则表明这是第一次请求，服务端正常执行业务逻辑。
    - 如果Token验证失败（不存在或删除失败），则表明是重复请求，服务端直接返回错误信息（如“请勿重复提交”），而不再处理业务。