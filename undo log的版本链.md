
![[Pasted image 20251102171053.png]]
- 实现版本链的数据结构：行数据的隐藏字段
	- `DB_ROW_ID`（隐藏主键）：行ID（Row ID）
		- 出现时机：当数据表没有显式定义主键（PRIMARY KEY）​​ 时候生成
	- `DB_TRX_ID`（事务ID）：
		- 记录的事务ID：插入或最后一次更新这条记录的事务
		- 作用：在快照读中用于判断数据版本对当前事务的可见性
	- `DB_ROLL_PTR`（回滚指针）：
		- 指向的记录：该行数据上一个版本的指针
			- 上一个版本的数据保存了被当前版本覆盖前的旧值
		- 作用：当发现数据版本对当前事务的不可见，进行版本回退
- undo log版本链的生成过程：
	- 增删时机：事务开始的时候插入，事务提交后是否删除
		- `INSERT` 操作：事务提交后即可删除
			- 因为其并没有旧值
		- ​ `UPDATE`/ `DELETE` 操作：事务提交后不立即删除
			- 删除时机：
				- 事务提交后不立即删除：
					- 需要为其他并发事务的快照读提供数据的历史版本
				- 当无活跃事务需要访问旧版本时，空间被标记可被回收
			- 删除方式：
				- 通过后台Purge线程清理不再需要的undo log
	- 连接方式：通过 `DB_ROLL_PTR`，一行数据的所有历史版本被连接成一个链表。
		- 最新版本在表数据中
		- 旧版本按修改时间倒序存放在 Undo Log 里。
- undo log链条：一个事务中可能产生多种类型的undo log，形成多个链表
	-  一个链表存储TRX_UNDO_INSERT类别的undo log
		- insert undo logs
			- 来源：对insert操作产生的undo log
			- 内容：记录下被插入记录的主键信息
			- 生命周期：该undo log可以在事务提交后可直接删除，不需要进行purge操作
				- 原因：insert操作的记录，只对事务本身可见，对其他事务不可见
	-  一个链表存储TRX_UNDO_UPDATE类别的undo log
		- update undo log
			- 来源：对delete和update操作产生的undo log
			- 内容：记录足够的信息来恢复到前一个版本（包含更新前列的旧值等信息）
			- 生命周期：不能在事务提交时就进行删除。提交时放入undo log链表，等待purge线程进行最后的删除。
				- 原因：该undo log可能需要提供MVCC机制
	-  临时表修改产生的undo log与常规undo log分开存储