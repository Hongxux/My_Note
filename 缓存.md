## 缓存的收益和成本
![[Pasted image 20251118104921.png]]
**引入缓存不是一个纯粹的技术优化，而是一种典型的架构权衡**。

- **对于短信登录这类高并发、对实时一致性要求并非极端的场景**，缓存的收益（高性能、高并发）远远大于其成本，因此是绝对正确的选择。
    
- 作为功能的Owner，您的职责不仅是实现功能，更要**主动管理和控制缓存带来的成本**：
    
    - 通过良好的设计（如我们讨论过的各种一致性方案）来**控制数据一致性成本**。
        
    - 通过封装工具类、制定开发规范、完善监控告警来**降低代码和维护成本**。
### 1. 缓存带来的收益（图的左侧）
**核心原因：读取内存的速度和读取磁盘速度的千倍**

这正是您选择Redis实现短信登录的核心原因：

- **降低后端负载**：在短信登录场景中，“后端”主要指您的**数据库（如MySQL）**。如果没有Redis缓存，每次Token验证都需要查询数据库，高并发下数据库极易成为瓶颈。将用户会话信息存入Redis，绝大部分请求在缓存层就被处理，数据库负载大幅降低，系统承载能力显著提升。
    
- **提高读写效率，降低响应时间**：Redis基于内存操作，读写速度远超数据库。这使得登录验证、Token校验等操作的延迟极低，**直接提升了用户的登录体验和系统性能**。
    

### 2. 缓存带来的成本（图的右侧）

这也是在设计和维护系统时必须持续关注和解决的问题：

- **数据一致性成本**：这是最核心的成本。当您更新了数据库中的用户信息（如昵称）时，如何确保Redis中的缓存数据同步更新？
    
    - **这与我们之前讨论的“先更新数据库，再删除缓存”、以及使用Canal或分布式锁等方案直接相关**。您需要根据业务场景，在**强一致性**（高成本、高性能损耗）和**最终一致性**（更常用的折中方案）之间做出权衡。引入缓存，就意味着您必须为数据一致性设计额外的机制。
        
    
- **代码维护成本**：
    
    1. **复杂性增加**：业务代码不再是简单的CRUD，需要加入缓存读写、失效、容错等逻辑。我们讨论的`BeanUtil.beanToMap`的类型转换问题、RedisTemplate的序列化配置，都是复杂性的体现。
        
    2. **运维复杂性**：你需要维护一个高可用的Redis集群，并监控其内存、CPU、带宽等指标，这增加了运维负担。
        
    3. **容灾处理**：正如面试模拟中问到的，如果Redis宕机，你的降级方案是什么？这都需要额外的代码和配置工作。
        
    

## 多级缓存架构

^e609a6

### 多级缓存架构详解
![[Pasted image 20251118105308.png]]
图中的流程图展示了一个请求数据从发起到最终落盘的完整路径，经过的各级缓存就像一个漏斗，层级越靠上，离用户越近，速度越快，但容量越小。

| 缓存层级 | 对应图中元素 | 作用与目的 | 举例 |
| :--- | :--- | :--- | :--- |
| 1. 浏览器缓存 | 最上层 | 将静态资源（如图片、CSS、JS）缓存在用户本地。目的：减少网络请求，实现最快速度的页面加载。 | 网站第二次打开时速度更快。 |
| 2. 应用层缓存 | Tomcat图标旁 | 在应用服务器内存中缓存热点数据（如数据库查询结果）。目的：减轻数据库压力，提升应用响应速度。 | 使用Redis等缓存数据库存储短信验证码、用户会话。 |
| 3. 数据库缓存 | 数据库图标旁 | 数据库自身维护的缓存，如缓存查询结果、索引数据。目的：加速数据库内部的查询速度。 | MySQL的Query Cache, InnoDB Buffer Pool。 |
| 4. CPU缓存 | CPU图标旁 | 位于CPU内部（L1/L2/L3），缓存内存中的数据。目的：弥补CPU高速与内存相对低速之间的差距。 | 计算机体系结构核心部分。 |
| 5. 磁盘缓存 | 硬盘图标旁 | 硬盘控制器上的缓存，缓存即将写入磁盘的数据。目的：将随机写操作优化为顺序写，提升IO性能。 | 硬盘的读写缓冲。 |

### 为什么这种多级缓存设计至关重要？

1.  性能最大化：每一级缓存都解决了不同层面的速度瓶颈。浏览器缓存解决了网络延迟，应用缓存解决了数据库IO压力，CPU缓存解决了内存访问延迟。最终共同作用，实现了极致的性能体验。
2.  成本与效率的平衡：速度越快的存储介质（如CPU缓存、内存）成本越高、容量越小。多级缓存结构使得我们可以用较小的成本，将最热点的数据存放在最快的介质中，从而实现成本和效率的最佳平衡。
3.  系统可扩展性：尤其是在分布式系统中，应用层缓存（如Redis集群） 的设计是系统能够横向扩展、应对高并发的关键。它使应用服务器成为无状态节点，便于水平扩展。### 添加Redis缓存



----
## 缓存的分类

- 分布式缓存，例如Redis:
	- 优点:存储容量更大、可靠性更好、可以在集群间共享
	- 缺点:访问缓存有网络开销
	- 场景:缓存数据量较大、可靠性要求较高、需要在集群间共享

- 进程本地缓存，例如HashMap、GuavaCache、[[Caffeine]]:
	- 优点:读取本地内存，没有网络开销，速度更快
	- 缺点:存储容量有限、可靠性较低、无法共享
	- 场景:性能要求较高，缓存数据量较小
---

## 缓存的设计
1. 缓存策略：
	- 对于常用的信息，不容易变更的信息，进行[[全量缓存]]
	- 对于变化快数据采用[[增量缓存]]
	- 对于热点数据：避免[[缓存击穿]]而选择逻辑过期
	- 对于复杂查询，缓存查询结果
2. 选择合适的数据结构

---

## [[缓存更新策略]]




