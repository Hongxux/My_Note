
![[Pasted image 20251119105949.png]]
![[Pasted image 20251119110021.png]]


**实现步骤**

1. **添加版本字段**：在数据库表和对应的实体类中，添加一个用于版本控制的字段（例如 `version`）。在JPA中，使用 `@Version`注解标记该字段
    
	    ```
	    @Entity
	    public class Product {
	        @Id
	        private Long id;
	        private String name;
	        private Integer stock;
	        @Version // 标识为版本字段
	        private Integer version;
	        // ... getters and setters
	    }
	    ```
    
2.  **更新时检查**：当执行更新操作（如 `entityManager.merge(entity)`）时，JPA/Hibernate会自动在UPDATE语句的WHERE条件中包含版本号检查
    
	    ```
	    -- 生成的SQL类似这样
	    UPDATE product SET stock = 10, version = version + 1 WHERE id = 1 AND version = 1;
	    ```
3. **处理冲突**：如果上述SQL执行后影响的行数为0，意味着在本次更新之前，该条数据已经被其他事务修改（版本号已变化）。此时，JPA会抛出 `OptimisticLockException`异常，你需要捕获这个异常并决定如何处理，例如提示用户或自动重试。