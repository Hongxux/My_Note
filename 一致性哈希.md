- 需求背景：在分布式服务器中，当服务器节点数量发生变化时，使用普通哈希实现的负载均衡，会发生“缓存雪崩”或“数据大规模迁移”。
	- 普通哈希： `hash(key) % N`，N为服务器数量![[Pasted image 20251125144647.png]]
- 解决方案：一致性哈希
	- 在节点数量变化时，**只影响相邻节点的数据**，保持大部分数据映射不变。


### 一致性哈希的原理--哈希环和虚拟节点
![[Pasted image 20251125144821.png]]
#### 第一步：构建哈希环

1. 创建一个巨大的哈希值空间（通常为0 ~ 2¹²⁸ - 1），并将其首尾相连形成一个**哈希环**
    
2. 对每个服务器节点计算哈希值（基于IP或唯一标识），并将其放置在环上
    
3. 对每个数据键计算哈希值，同样放置在环上
    

#### 第二步：确定数据归属

- 从数据的哈希值点在环上**顺时针方向**查找，遇到的**第一个节点**就是该数据的归属节点
    - 当增加或者删除一台服务器时，受影响的数据仅仅是新添加或删除的服务器到其环空间中前一台的服务器（也就是顺着逆时针方向遇到的第一台服务器）之间的数据，其他都不会受到影响。![[Pasted image 20251125144844.png]]![[Pasted image 20251125144851.png]]

#### 第三步：虚拟节点解决数据倾斜
![[Pasted image 20251125144912.png]]
基础的一致性哈希可能产生**数据分布不均**的问题。为此引入**虚拟节点**概念：
1. 每一个物理服务节点映射多个虚拟节点
2. 将这些虚拟节点计算哈希值并映射到哈希环上（使得虚拟节点散列分布）
3. 当请求找到某个虚拟节点后，将被重新映射到具体的物理节点。![[Pasted image 20251125144958.png]]